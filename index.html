<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Gym Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #050510;
            color: #b8b8d0;
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            max-width: 100%;
            min-height: 100vh;
        }

        .header {
            background: #0d0d1a;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #3a2a5a;
            box-shadow: 0 4px 20px rgba(58, 42, 90, 0.2);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 24px;
        }

        .week-indicator {
            font-size: 14px;
            color: #6a5a8a;
            margin-bottom: 15px;
        }

        .settings-btn {
            background: none;
            border: none;
            color: #6a5a8a;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #3a2a5a;
            border-color: #4a3a6a;
            color: #b8b8d0;
        }

        .nav-btn:active {
            transform: scale(0.98);
        }

        .content {
            padding: 20px;
        }

        .day-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .day-btn {
            flex: 1;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .day-btn.active {
            background: #3a2a5a;
            border-color: #4a3a6a;
            color: #b8b8d0;
        }

        .day-btn:only-child {
            flex: 1 1 100%;
            min-width: 100%;
        }

        .section-title {
            font-size: 14px;
            color: #6a5a8a;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 10px 0;
            font-weight: 600;
        }

        .exercise-card {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #1a1a2a;
        }

        .exercise-card.logged {
            border-color: #3a2a5a;
            background: #12121f;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .exercise-name {
            font-size: 16px;
            font-weight: 600;
        }

        .previous-data {
            font-size: 12px;
            color: #888;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            flex: 1;
        }

        .input-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
            display: block;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            background: #1a1a2a;
            border: 2px solid #2a2a3a;
            border-radius: 8px;
            color: #b8b8d0;
            font-size: 16px;
            -webkit-appearance: none;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .input-field.error {
            border-color: #ff5555;
        }

        .input-field:focus {
            outline: none;
            border-color: #3a2a5a;
        }

        .input-field:disabled {
            opacity: 0.5;
        }

        .log-btn {
            width: 100%;
            padding: 12px;
            background: #3a2a5a;
            border: none;
            border-radius: 8px;
            color: #b8b8d0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .log-btn:active {
            transform: scale(0.98);
        }

        .log-btn.logged {
            background: #1a1a2a;
            color: #6a5a8a;
        }

        .save-btn {
            width: 100%;
            padding: 16px;
            background: #2a1a3a;
            border: none;
            border-radius: 12px;
            color: #b8b8d0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .save-btn:disabled {
            background: #1a1a2a;
            color: #666;
        }

        .week-nav {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .week-nav-btn {
            padding: 8px 16px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .week-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .week-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
        }

        .history-item {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #1a1a2a;
        }

        .history-date {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .history-exercise {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #1a1a2a;
            font-size: 14px;
        }

        .history-exercise:last-child {
            border-bottom: none;
        }

        .history-exercise-name {
            color: #6a5a8a;
        }

        .history-exercise-data {
            font-weight: 600;
        }

        .chart-container {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #1a1a2a;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .success-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #3a2a5a;
            color: #b8b8d0;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .exercise-select {
            width: 100%;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            color: #b8b8d0;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .exercise-select option {
            background: #0d0d1a;
            color: #b8b8d0;
        }

        canvas {
            max-height: 250px;
        }


        @keyframes pr-pulse {
            0% {
                box-shadow: inset 0 0 0px 0px rgba(255, 215, 0, 0);
            }
            50% {
                box-shadow: inset 0 0 80px 20px rgba(255, 215, 0, 0.8);
            }
            100% {
                box-shadow: inset 0 0 0px 0px rgba(255, 215, 0, 0);
            }
        }

        .pr-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-left: 8px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .pr-suggestion {
            font-size: 11px;
            color: #6a5a8a;
            margin-bottom: 4px;
            font-weight: 600;
            height: 16px;
            visibility: visible;
        }

        .pr-suggestion.hidden {
            visibility: hidden;
        }

        .input-field.pr-attempt {
            border: 2px solid #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1));
        }


        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(5, 5, 16, 0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            border: 1px solid #2a2a3a;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        .modal-btn.primary {
            background: #3a2a5a;
            border-color: #3a2a5a;
            color: #b8b8d0;
        }

        .modal-btn.danger {
            background: #3a1a2a;
            border-color: #3a1a2a;
            color: #b8b8d0;
        }

        .file-input {
            display: none;
        }

        .backup-reminder {
            background: #ff9500;
        }

        /* Setup Wizard Styles */
        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #050510;
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        .wizard-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .wizard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .wizard-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #b8b8d0;
        }

        .wizard-subtitle {
            font-size: 16px;
            color: #6a5a8a;
        }

        .wizard-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 40px;
        }

        .wizard-progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #1a1a2a;
            transition: all 0.3s;
        }

        .wizard-progress-dot.active {
            background: #3a2a5a;
            width: 40px;
            border-radius: 6px;
        }

        .wizard-progress-dot.completed {
            background: #2a4a3a;
        }

        .wizard-content {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid #1a1a2a;
        }

        .template-grid {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .template-card {
            background: #1a1a2a;
            border: 2px solid #2a2a3a;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-card:hover {
            border-color: #3a2a5a;
            background: #1f1f2f;
        }

        .template-card.selected {
            border-color: #3a2a5a;
            background: #2a1a3a;
        }

        .template-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .template-name {
            font-size: 18px;
            font-weight: 600;
            color: #b8b8d0;
        }

        .template-badge {
            font-size: 12px;
            padding: 4px 8px;
            background: #3a2a5a;
            border-radius: 4px;
            color: #b8b8d0;
        }

        .template-description {
            font-size: 14px;
            color: #8a8aa0;
            line-height: 1.5;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: #1a1a2a;
            border: 2px solid #2a2a3a;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            border-color: #3a2a5a;
        }

        .calendar-day.active {
            border-color: #3a2a5a;
            background: #2a1a3a;
        }

        .calendar-day-name {
            font-size: 12px;
            color: #6a5a8a;
            margin-bottom: 4px;
        }

        .calendar-day-number {
            font-size: 20px;
            font-weight: 700;
            color: #b8b8d0;
        }

        .calendar-day.rest .calendar-day-number {
            color: #6a5a8a;
        }

        /* Mobile responsive calendar - 2 rows */
        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .calendar-day {
                padding: 10px;
            }

            .calendar-day-name {
                font-size: 10px;
                margin-bottom: 3px;
            }

            .calendar-day-number {
                font-size: 16px;
            }

            /* Build Your Workouts day selector - wrap to 2 rows on mobile */
            .workout-day-selector button {
                flex: 1 1 calc(33.333% - 6px);
                max-width: calc(33.333% - 6px);
            }

            /* Build Your Workouts exercise rows - stack inputs below exercise name on mobile */
            .wizard-exercise-row > div:first-child {
                margin-bottom: 8px;
            }

            /* Workout page day selector - wrap to 2 rows on mobile */
            .day-btn {
                flex: 1 1 calc(25% - 8px);
                min-width: calc(25% - 8px);
                max-width: calc(25% - 8px);
            }
        }

        .wizard-buttons {
            display: flex;
            gap: 12px;
        }

        .wizard-btn {
            flex: 1;
            padding: 16px;
            background: #2a1a3a;
            border: none;
            border-radius: 12px;
            color: #b8b8d0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .wizard-btn:hover {
            background: #3a2a5a;
        }

        .wizard-btn:active {
            transform: scale(0.98);
        }

        .wizard-btn.secondary {
            background: #1a1a2a;
            color: #8a8aa0;
        }

        .wizard-btn.secondary:hover {
            background: #2a2a3a;
        }

        .wizard-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .wizard-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .exercise-preview {
            margin-top: 20px;
        }

        .exercise-preview-title {
            font-size: 14px;
            color: #6a5a8a;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .exercise-preview-list {
            background: #1a1a2a;
            border-radius: 8px;
            padding: 16px;
        }

        .exercise-preview-item {
            padding: 8px 0;
            color: #8a8aa0;
            font-size: 14px;
            border-bottom: 1px solid #2a2a3a;
        }

        .exercise-preview-item:last-child {
            border-bottom: none;
        }

        .summary-section {
            margin-bottom: 24px;
        }

        .summary-label {
            font-size: 12px;
            color: #6a5a8a;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 16px;
            color: #b8b8d0;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // User bodyweight for bodyweight exercises
        const userBodyweight = 185;

        // Calculate which day it should be based on the date
        function getTodayDay() {
            // Load schedule from localStorage
            const savedSchedule = storage.getItem('gymScheduleConfig');
            if (!savedSchedule) {
                // Fallback to alternating days if no schedule
                const today = new Date();
                const referenceDate = new Date(2025, 11, 14);
                today.setHours(0, 0, 0, 0);
                referenceDate.setHours(0, 0, 0, 0);
                const diffTime = today - referenceDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                return (diffDays % 2 === 0) ? 1 : 2;
            }

            const schedule = JSON.parse(savedSchedule);
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday

            // Map day numbers to day names
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const todayName = dayNames[dayOfWeek];

            // Find today's workout day from schedule
            const todayWorkout = schedule.workoutDays.find(wd => wd.dayOfWeek === todayName);

            if (todayWorkout) {
                return todayWorkout.workoutDayNumber;
            }

            // If today is not a workout day, return the first workout day or default to 1
            return schedule.workoutDays.length > 0 ? schedule.workoutDays[0].workoutDayNumber : 1;
        }

        // Get the Monday of the week containing a given date
        function getMondayOfWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const day = d.getDay();
            const diff = day === 0 ? -6 : 1 - day; // If Sunday (0), go back 6 days; otherwise go to Monday
            d.setDate(d.getDate() + diff);
            return d;
        }

        // Get the Monday of the first workout (Week 1 start date)
        // This is cached in localStorage to avoid recalculating
        function getFirstWorkoutMonday(workoutHistory) {
            // Try to get cached value first
            const cached = storage.getItem('firstWorkoutMonday');
            if (cached) {
                return new Date(cached);
            }

            // If no cache and no workout history, use today as default
            if (!workoutHistory || workoutHistory.length === 0) {
                const today = getMondayOfWeek(new Date());
                storage.setItem('firstWorkoutMonday', today.toISOString());
                return today;
            }

            // Find the earliest workout date
            const earliestWorkout = workoutHistory.reduce((earliest, workout) => {
                const workoutDate = new Date(workout.date);
                return !earliest || workoutDate < earliest ? workoutDate : earliest;
            }, null);

            // Get the Monday of that week
            const firstMonday = getMondayOfWeek(earliestWorkout);

            // Cache it for future use
            storage.setItem('firstWorkoutMonday', firstMonday.toISOString());

            return firstMonday;
        }

        // Calculate consecutive week number starting from first workout
        // Week 1 = the week of the first workout, incrementing indefinitely
        function getConsecutiveWeek(date, workoutHistory) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);

            const firstMonday = getFirstWorkoutMonday(workoutHistory);
            const currentMonday = getMondayOfWeek(d);

            // Calculate weeks difference
            const diffTime = currentMonday - firstMonday;
            const diffWeeks = Math.floor(diffTime / (7 * 24 * 60 * 60 * 1000));

            return diffWeeks + 1; // Week 1 is the first week
        }

        // Calculate current week number (consecutive weeks starting from first workout)
        function getCurrentWeek(workoutHistory) {
            return getConsecutiveWeek(new Date(), workoutHistory);
        }

        // Get week number for a specific date
        function getWeekNumber(date, workoutHistory) {
            return getConsecutiveWeek(date, workoutHistory);
        }

        // Parse MM:SS to total seconds
        function parseTimeToSeconds(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            if (parts.length !== 2) return 0;
            const minutes = parseInt(parts[0]) || 0;
            const seconds = parseInt(parts[1]) || 0;
            return minutes * 60 + seconds;
        }

        // Format seconds to MM:SS
        function formatSecondsToTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Generate deterministic hash for verification purposes
        function hashVerifier(input) {
            let hash = 0;
            for (let i = 0; i < input.length; i++) {
                const char = input.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        }

        // Verify doom_id against manifest
        function verifyDoomId(doomId) {
            const manifest = {
                'D0O0O0M1': 'lexi',
                'D1O9O9M2': 'jessi',
                'D6O9O6M9': 'graciepoo'
            };
            return manifest[doomId] || null;
        }

        // Get preset template by identifier
        function getPresetTemplate(identifier) {
            const templates = {

                'lexi': {
                    name: 'Upper/Lower Split',
                    workoutDays: {
                        1: {
                            name: 'Upper',
                            exercises: [
                                { name: 'Bench Press', sets: 4, minReps: 6, maxReps: 8 },
                                { name: 'Barbell Row', sets: 4, minReps: 6, maxReps: 8 },
                                { name: 'Overhead Press', sets: 3, minReps: 8, maxReps: 10 },
                                { name: 'Lat Pulldown', sets: 3, minReps: 8, maxReps: 12 },
                                { name: 'Dumbbell Lateral Raise', sets: 3, minReps: 12, maxReps: 15 },
                                { name: 'Cable Bicep Curl', sets: 3, minReps: 10, maxReps: 12 },
                                { name: 'Tricep Rope Pushdown', sets: 3, minReps: 10, maxReps: 12 }
                            ]
                        },
                        2: {
                            name: 'Lower',
                            exercises: [
                                { name: 'Squat', sets: 4, minReps: 6, maxReps: 8 },
                                { name: 'Romanian Deadlift', sets: 3, minReps: 8, maxReps: 10 },
                                { name: 'Leg Press', sets: 3, minReps: 10, maxReps: 12 },
                                { name: 'Leg Curl', sets: 3, minReps: 10, maxReps: 12 },
                                { name: 'Leg Extension', sets: 3, minReps: 10, maxReps: 12 },
                                { name: 'Calf Raise', sets: 4, minReps: 12, maxReps: 15 },
                                { name: 'Plank', sets: 3, minReps: 30, maxReps: 60 }
                            ]
                        }
                    }
                },

                'jessi': {
                    name: 'Upper/Lower Split',
                    bypassSchedule: true,
                    schedule: ['Tuesday', 'Wednesday'],
                    workoutDays: {
                        1: {
                            name: 'Upper',
                            exercises: [
                                { name: 'Flat Chest Press Machine', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Shoulder Press Machine', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Preacher Curls', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Tricep Pushdowns', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Wide Grip Lat Pulldowns', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Upper Back Row Machine', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Neutral Grip Row Machine', sets: 1, minReps: 6, maxReps: 8 },
                            ]
                        },

                        2: {
                            name: 'Lower',
                            exercises: [
                                { name: 'Leg Extensions', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Seated Leg Curls', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Pendulum Squat', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Hip Thrusts', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Hip Adduction Machine', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Calf Raise Machine', sets: 1, minReps: 6, maxReps: 8 },
                            ]
                        }

                    }
                },

                'graciepoo': {
                    name: 'Full Body Split',
                    bypassSchedule: true,
                    workoutDays: {
                        1: {
                            name: 'Full Body',
                            exercises: [
                                { name: 'Romanian Deadlifts', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Seated Leg Curls', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Pendulum Squat', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Hip Thrusts', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Hip Adductor Machine', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Glute Kickbacks', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Leg Extensions', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Standing Calf Raises', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Neutral Grip Row Machine', sets: 1, minReps: 6, maxReps: 8 },
                                { name: 'Chest Press Machine', sets: 1, minReps: 6, maxReps: 8 },
                            ]
                        }

                    }
                }

            };

            return templates[identifier] || null;
        }

        // Namespace localStorage based on app path to prevent conflicts between gym-tracker and public-gym-app
        const APP_NAMESPACE = (() => {
            const path = window.location.pathname;
            if (path.includes('/gym-tracker/')) return 'gym-tracker:';
            if (path.includes('/public-gym-app/')) return 'public-gym-app:';
            // Fallback for local development or other paths
            return 'gym-local:';
        })();

        // Helper functions for namespaced localStorage
        const storage = {
            getItem: (key) => localStorage.getItem(APP_NAMESPACE + key),
            setItem: (key, value) => localStorage.setItem(APP_NAMESPACE + key, value),
            removeItem: (key) => localStorage.removeItem(APP_NAMESPACE + key),
        };

        // Migrate existing data to namespaced keys (one-time migration for existing users)
        function migrateToNamespacedStorage() {
            const keysToMigrate = ['gymWorkoutHistory', 'gymExerciseConfig', 'lastBackupReminder'];

            keysToMigrate.forEach(key => {
                // Check if data exists in the old location (without namespace)
                const oldData = localStorage.getItem(key);
                // Check if data already exists in the new location (with namespace)
                const newData = storage.getItem(key);

                // Only migrate if old data exists and new location is empty
                if (oldData && !newData) {
                    storage.setItem(key, oldData);
                    // Optionally remove the old data to clean up
                    // Commenting this out to be safe - users can manually clear old data later
                    // localStorage.removeItem(key);
                }
            });
        }

        // Generate UUID for exercises
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ============================================================================
        // EXERCISE WORD BANK
        // ============================================================================

        const EXERCISE_WORD_BANK = [
            // Most Common "Big 3"
            'Bench Press', 'Deadlift', 'Squat',

            // Common Compound Movements
            'Overhead Press', 'Barbell Row', 'Pull-ups', 'Dips',
            'Lat Pulldown', 'Leg Press', 'Romanian Deadlift',

            // Chest
            'Incline Bench Press', 'Dumbbell Press', 'Incline Dumbbell Press',
            'Decline Bench Press', 'Chest Flies', 'Cable Flies', 'Push-ups', 'Incline Chest Press Machine', 'Chest Press Machine',

            // Back
            'Dumbbell Row', 'T Bar Row', 'Chest Supported Row', 'Cable Row', 'Chin-ups',
            'Face Pulls', 'Shrugs', 'Kelso Shrugs', 'Seated Cable Row', 'Wide Grip Lat Pulldown', 'Row Machine', 'Pulldown Machine',

            // Shoulders
            'Shoulder Press', 'Lateral Raises', 'Cable Lateral Raises', 'Front Raises',
            'Rear Delt Flies', 'Arnold Press', 'Upright Row',

            // Arms
            'Barbell Curls', 'Hammer Curls', 'Tricep Pushdown',
            'Overhead Tricep Extension', 'Dumbbell Curls', 'Preacher Curls', 'Cable Curls', 'Bayesian Curls', 
            'Concentration Curls', 'Tricep Dips', 'Skull Crushers',
            'Close-Grip Bench Press',

            // Legs
            'Front Squat', 'Leg Extensions', 'Seated Leg Curls', 'Prone Leg Curls', 'Bulgarian Split Squat',
            'Lunges', 'Calf Raises', 'Hip Adduction', 'Hip Abduction', 'Hip Thrusts', 'Glute Bridge',

            // Core
            'Ab Crunch', 'Hanging Leg Raises', 'Plank', 'Russian Twists',
            'Cable Crunches', 'Bicycle Crunches',

            // Cardio
            'Treadmill', 'StairMaster', 'Assault Bike', 'Rowing Machine',
            'Elliptical', 'Jump Rope', 'Battle Ropes', 'Cycling', 'Walking', 'Incline Walking',
            'Running', 'Sprinting', 'Jogging'
        ];

        // Cardio exercises list for conditional rendering
        const CARDIO_EXERCISES = [
            'Treadmill', 'StairMaster', 'Assault Bike', 'Rowing Machine',
            'Elliptical', 'Jump Rope', 'Battle Ropes', 'Cycling', 'Walking', 'Incline Walking',
            'Running', 'Sprinting', 'Jogging'
        ];

        // Helper function to check if an exercise is cardio
        function isCardioExercise(exerciseName) {
            return CARDIO_EXERCISES.some(cardio =>
                exerciseName.toLowerCase().includes(cardio.toLowerCase())
            );
        }

        // ============================================================================
        // SETUP WIZARD COMPONENTS
        // ============================================================================

        function SetupWizard({ onComplete }) {
            const [step, setStep] = useState(1);
            const [schedule, setSchedule] = useState(null);
            const [workoutDays, setWorkoutDays] = useState({}); // { 1: { name: 'Push', exercises: [...] }, 2: { ... } }
            const [isCoachMode, setIsCoachMode] = useState(false);
            const [coachIdentifier, setCoachIdentifier] = useState(null);

            const goNext = () => setStep(step + 1);
            const goBack = () => {
                if (step === 2 && isCoachMode) {
                    setStep(1.5); // Go back to coach ID step
                } else {
                    setStep(step - 1);
                }
            };

            const handleCoachMode = () => {
                setIsCoachMode(true);
                setStep(1.5); // Coach ID step
            };

            const handleCoachIdVerified = (identifier) => {
                setCoachIdentifier(identifier);
                const preset = getPresetTemplate(identifier);

                // Check if template has bypassSchedule enabled
                if (preset && preset.bypassSchedule) {
                    // Auto-detect number of workout days in preset
                    const numWorkoutDays = Object.keys(preset.workoutDays).length;

                    // Use custom schedule from preset, or default to Mon/Wed/Fri
                    const weekDays = preset.schedule || ['Monday', 'Wednesday', 'Friday'];
                    const scheduleWorkoutDays = weekDays.map((day, index) => ({
                        dayOfWeek: day,
                        workoutDayNumber: (index % numWorkoutDays) + 1
                    }));

                    const generatedSchedule = {
                        workoutDays: scheduleWorkoutDays,
                        totalWorkoutDays: numWorkoutDays
                    };

                    setSchedule(generatedSchedule);
                    setWorkoutDays(preset.workoutDays);

                    // Trigger completion immediately to bypass all setup screens
                    // Using setTimeout to ensure state updates have propagated
                    setTimeout(() => {
                        // Convert to exercise config format
                        const exercisesByDay = {};
                        const allCategories = new Set();

                        Object.entries(preset.workoutDays).forEach(([dayNum, dayData]) => {
                            exercisesByDay[dayNum] = dayData.exercises.map((ex, idx) => {
                                if (ex.isCardio) {
                                    return {
                                        id: generateUUID(),
                                        name: ex.name,
                                        category: dayData.name,
                                        typeId: 'cardio',
                                        isCardio: true,
                                        intensity: ex.intensity || '',
                                        minutes: ex.minutes || 0,
                                        seconds: ex.seconds || 0,
                                        order: idx
                                    };
                                } else {
                                    return {
                                        id: generateUUID(),
                                        name: ex.name,
                                        category: dayData.name,
                                        typeId: 'standard',
                                        sets: ex.sets || 3,
                                        minReps: ex.minReps || 8,
                                        maxReps: ex.maxReps || 12,
                                        order: idx
                                    };
                                }
                            });
                            allCategories.add(dayData.name);
                        });

                        // Save to localStorage
                        storage.setItem('gymSetupCompleted', JSON.stringify({
                            version: 1,
                            completed: true,
                            completedAt: new Date().toISOString()
                        }));

                        storage.setItem('gymScheduleConfig', JSON.stringify({
                            version: 2,
                            ...generatedSchedule
                        }));

                        storage.setItem('gymExerciseConfig', JSON.stringify({
                            version: 2,
                            days: exercisesByDay,
                            categories: Array.from(allCategories)
                        }));

                        onComplete();
                    }, 0);
                } else {
                    setStep(2); // Go to schedule step
                }
            };

            const handleScheduleComplete = (newSchedule) => {
                setSchedule(newSchedule);

                if (isCoachMode && coachIdentifier) {
                    // Load preset workouts for coach mode
                    const preset = getPresetTemplate(coachIdentifier);
                    if (preset) {
                        const uniqueDays = Array.from(new Set(newSchedule.workoutDays.map(d => d.workoutDayNumber))).sort();
                        const presetDays = {};

                        uniqueDays.forEach((dayNum, index) => {
                            const presetDayNum = (index % Object.keys(preset.workoutDays).length) + 1;
                            const presetDay = preset.workoutDays[presetDayNum];
                            if (presetDay) {
                                presetDays[dayNum] = {
                                    name: presetDay.name,
                                    exercises: [...presetDay.exercises]
                                };
                            }
                        });

                        setWorkoutDays(presetDays);
                        setStep(4); // Skip exercise building, go straight to confirm
                        return;
                    }
                }

                // Normal flow - Initialize empty workout days
                const uniqueDays = Array.from(new Set(newSchedule.workoutDays.map(d => d.workoutDayNumber))).sort();
                const initialDays = {};
                uniqueDays.forEach(dayNum => {
                    initialDays[dayNum] = {
                        name: `Day ${dayNum}`,
                        exercises: []
                    };
                });
                setWorkoutDays(initialDays);

                goNext();
            };

            const handleExercisesComplete = (newWorkoutDays) => {
                setWorkoutDays(newWorkoutDays);
                goNext();
            };

            const handleComplete = () => {
                // Convert to exercise config format
                const exercisesByDay = {};
                const allCategories = new Set();

                Object.entries(workoutDays).forEach(([dayNum, dayData]) => {
                    exercisesByDay[dayNum] = dayData.exercises.map((ex, idx) => {
                        if (ex.isCardio) {
                            return {
                                id: generateUUID(),
                                name: ex.name,
                                category: dayData.name,
                                typeId: 'cardio',
                                isCardio: true,
                                intensity: ex.intensity || '',
                                minutes: ex.minutes || 0,
                                seconds: ex.seconds || 0,
                                order: idx
                            };
                        } else {
                            return {
                                id: generateUUID(),
                                name: ex.name,
                                category: dayData.name,
                                typeId: 'standard',
                                sets: ex.sets || 3,
                                minReps: ex.minReps || 8,
                                maxReps: ex.maxReps || 12,
                                order: idx
                            };
                        }
                    });
                    allCategories.add(dayData.name);
                });

                // Save to localStorage
                storage.setItem('gymSetupCompleted', JSON.stringify({
                    version: 1,
                    completed: true,
                    completedAt: new Date().toISOString()
                }));

                storage.setItem('gymScheduleConfig', JSON.stringify({
                    version: 2,
                    ...schedule
                }));

                storage.setItem('gymExerciseConfig', JSON.stringify({
                    version: 2,
                    days: exercisesByDay,
                    categories: Array.from(allCategories)
                }));

                onComplete();
            };

            const presetTemplate = isCoachMode && coachIdentifier ? getPresetTemplate(coachIdentifier) : null;

            return (
                <div className="wizard-overlay">
                    <div className="wizard-container">
                        {step === 1 && <WelcomeStep onNext={goNext} onCoach={handleCoachMode} />}
                        {step === 1.5 && <CoachIdStep onNext={handleCoachIdVerified} onBack={() => { setIsCoachMode(false); setStep(1); }} />}
                        {step === 2 && <ScheduleStep onNext={handleScheduleComplete} onBack={goBack} isCoachMode={isCoachMode} presetTemplate={presetTemplate} />}
                        {step === 3 && <ExerciseBuildingStep schedule={schedule} initialWorkoutDays={workoutDays} onNext={handleExercisesComplete} onBack={goBack} />}
                        {step === 4 && <ConfirmStep schedule={schedule} workoutDays={workoutDays} onComplete={handleComplete} onBack={goBack} />}
                    </div>
                </div>
            );
        }

        function WelcomeStep({ onNext, onCoach }) {
            return (
                <>
                    <div className="wizard-header">
                        <div className="wizard-icon">üí™</div>
                        <h1 className="wizard-title">Welcome to Gym Tracker</h1>
                        <p className="wizard-subtitle">Let's set up your personalized workout program</p>
                    </div>

                    <div className="wizard-progress">
                        <div className="wizard-progress-dot active"></div>
                        <div className="wizard-progress-dot"></div>
                        <div className="wizard-progress-dot"></div>
                        <div className="wizard-progress-dot"></div>
                    </div>

                    <div className="wizard-content" style={{ textAlign: 'center' }}>
                        <p style={{ fontSize: '16px', color: '#8a8aa0', lineHeight: '1.6', marginBottom: '20px' }}>
                            Build a fully customized program that works for you:
                        </p>
                        <ul style={{ textAlign: 'left', fontSize: '14px', color: '#8a8aa0', lineHeight: '2', listStyle: 'none', padding: 0 }}>
                            <li>üìÖ Pick which days you work out</li>
                            <li>üèãÔ∏è Name your workout days (Push/Pull/Legs, Upper/Lower, etc.)</li>
                            <li>‚úèÔ∏è Choose exercises or type your own</li>
                            <li>üìà Track progress and PRs over time</li>
                        </ul>
                    </div>

                    <div className="wizard-buttons">
                        <button className="wizard-btn" style={{ background: '#2a2a3a', marginTop: '10px' }} onClick={onCoach}>I Have a Coach</button>
                        <button className="wizard-btn" onClick={onNext}>Get Started</button>
                    </div>
                </>
            );
        }

        function CoachIdStep({ onNext, onBack }) {
            const [doomId, setDoomId] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = () => {
                const identifier = verifyDoomId(doomId.trim());
                if (identifier) {
                    onNext(identifier);
                } else {
                    setError('Invalid ID. Please check with your coach.');
                }
            };

            return (
                <>
                    <div className="wizard-header">
                        <div className="wizard-icon">üîë</div>
                        <h1 className="wizard-title">Enter Your Coach ID</h1>
                        <p className="wizard-subtitle">Enter the unique ID provided by your coach</p>
                    </div>

                    <div className="wizard-progress">
                        <div className="wizard-progress-dot active"></div>
                        <div className="wizard-progress-dot"></div>
                        <div className="wizard-progress-dot"></div>
                        <div className="wizard-progress-dot"></div>
                    </div>

                    <div className="wizard-content">
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ display: 'block', marginBottom: '8px', color: '#b8b8d0', fontSize: '14px' }}>
                                Coach ID
                            </label>
                            <input
                                type="text"
                                value={doomId}
                                onChange={(e) => {
                                    setDoomId(e.target.value);
                                    setError('');
                                }}
                                placeholder="Enter your ID"
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    background: '#1a1a2a',
                                    border: error ? '2px solid #ff4444' : '1px solid #2a2a3a',
                                    borderRadius: '8px',
                                    color: '#b8b8d0',
                                    fontSize: '16px',
                                    outline: 'none'
                                }}
                                onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
                            />
                            {error && (
                                <p style={{ color: '#ff4444', fontSize: '12px', marginTop: '8px' }}>
                                    {error}
                                </p>
                            )}
                        </div>
                    </div>

                    <div className="wizard-buttons">
			<button className="wizard-btn secondary" onClick={onBack}>Back</button>
                        <button className="wizard-btn" onClick={handleSubmit}>Continue</button>
                    </div>
                </>
            );
        }

        function ScheduleStep({ onNext, onBack, isCoachMode, presetTemplate }) {
            const [schedule, setSchedule] = useState([]);

            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            // Get max days allowed based on preset template
            const maxDays = isCoachMode && presetTemplate
                ? Object.keys(presetTemplate.workoutDays).length
                : Infinity;

            const daysRemaining = maxDays === Infinity ? 0 : maxDays - schedule.length;

            const toggleDay = (dayOfWeek) => {
                const existingDay = schedule.find(d => d.dayOfWeek === dayOfWeek);

                if (existingDay) {
                    // Remove this day
                    setSchedule(schedule.filter(d => d.dayOfWeek !== dayOfWeek));
                } else {
                    // Check if we've reached the max for coach mode
                    if (isCoachMode && schedule.length >= maxDays) {
                        return; // Don't allow more days
                    }

                    // Add this day - assign next available workout day number
                    const usedDayNumbers = new Set(schedule.map(d => d.workoutDayNumber));
                    let nextDayNumber = 1;
                    while (usedDayNumbers.has(nextDayNumber)) {
                        nextDayNumber++;
                    }
                    setSchedule([...schedule, { dayOfWeek, workoutDayNumber: nextDayNumber }]);
                }
            };

            const changeDayNumber = (dayOfWeek, newNumber) => {
                setSchedule(schedule.map(d =>
                    d.dayOfWeek === dayOfWeek ? { ...d, workoutDayNumber: newNumber } : d
                ));
            };

            const handleContinue = () => {
                const uniqueDays = new Set(schedule.map(d => d.workoutDayNumber));
                onNext({
                    workoutDays: schedule,
                    totalWorkoutDays: uniqueDays.size
                });
            };

            const isActive = (day) => schedule.some(d => d.dayOfWeek === day);
            const getDayNumber = (day) => schedule.find(d => d.dayOfWeek === day)?.workoutDayNumber || 1;
            const maxDayNumber = Math.max(1, ...schedule.map(d => d.workoutDayNumber));

            return (
                <>
                    <div className="wizard-header">
                        <h1 className="wizard-title">Set Your Schedule</h1>
                        <p className="wizard-subtitle">
                            {isCoachMode && presetTemplate ? (
                                <>
                                    {presetTemplate.name}
                                    <br />
                                    <span style={{ fontSize: '14px', color: '#6a5a8a' }}>{maxDays}-day Split</span>
                                </>
                            ) : (
                                'Which days will you work out?'
                            )}
                        </p>
                    </div>

                    <div className="wizard-progress">
                        <div className="wizard-progress-dot completed"></div>
                        <div className="wizard-progress-dot active"></div>
                        <div className="wizard-progress-dot"></div>
                        <div className="wizard-progress-dot"></div>
                    </div>

                    <div className="wizard-content">
                        {isCoachMode && daysRemaining > 0 && (
                            <div style={{
                                textAlign: 'center',
                                marginBottom: '20px',
                                fontSize: '14px',
                                color: '#8a8aa0',
                                padding: '12px',
                                background: '#1a1a2a',
                                borderRadius: '8px',
                                border: '1px solid #2a2a3a'
                            }}>
                                Pick {daysRemaining} More {daysRemaining === 1 ? 'Day' : 'Days'}
                            </div>
                        )}

                        <div className="calendar-grid">
                            {daysOfWeek.map(day => (
                                <div
                                    key={day}
                                    className={`calendar-day ${isActive(day) ? 'active' : 'rest'}`}
                                    onClick={() => toggleDay(day)}
                                    style={{
                                        opacity: (isCoachMode && !isActive(day) && schedule.length >= maxDays) ? 0.3 : 1,
                                        cursor: (isCoachMode && !isActive(day) && schedule.length >= maxDays) ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    <div className="calendar-day-name">{day.substring(0, 3)}</div>
                                    <div className="calendar-day-number">
                                        {isActive(day) ? getDayNumber(day) : 'Rest'}
                                    </div>
                                </div>
                            ))}
                        </div>

                    </div>

                    <div className="wizard-buttons">
                        <button className="wizard-btn secondary" onClick={onBack}>Back</button>
                        <button className="wizard-btn" onClick={handleContinue} disabled={isCoachMode ? schedule.length !== maxDays : schedule.length === 0}>
                            Continue
                        </button>
                    </div>
                </>
            );
        }

        function ExerciseBuildingStep({ schedule, initialWorkoutDays, onNext, onBack }) {
            const [workoutDays, setWorkoutDays] = useState(initialWorkoutDays);
            const [selectedDay, setSelectedDay] = useState(null);
            const [customExercise, setCustomExercise] = useState('');
            const [showExample, setShowExample] = useState(false);
            const [validationErrors, setValidationErrors] = useState({});

            const uniqueDays = Array.from(new Set(schedule.workoutDays.map(d => d.workoutDayNumber))).sort();

            // Auto-select first day on mount
            useEffect(() => {
                if (!selectedDay && uniqueDays.length > 0) {
                    setSelectedDay(uniqueDays[0]);
                }
            }, []);

            const currentDay = workoutDays[selectedDay];

            const updateDayName = (dayNum, newName) => {
                setWorkoutDays({
                    ...workoutDays,
                    [dayNum]: {
                        ...workoutDays[dayNum],
                        name: newName
                    }
                });
            };

            const addExercise = (exerciseName) => {
                if (!exerciseName.trim()) return;

                const trimmedName = exerciseName.trim();
                const isCardio = isCardioExercise(trimmedName);

                const newExercise = isCardio ? {
                    name: trimmedName,
                    isCardio: true,
                    intensity: '',
                    minutes: 0,
                    seconds: 0
                } : {
                    name: trimmedName,
                    sets: 3,
                    minReps: 8,
                    maxReps: 12
                };

                setWorkoutDays({
                    ...workoutDays,
                    [selectedDay]: {
                        ...workoutDays[selectedDay],
                        exercises: [...workoutDays[selectedDay].exercises, newExercise]
                    }
                });

                setCustomExercise('');
            };

            const updateExerciseField = (dayNum, exerciseIndex, field, value) => {
                const updatedExercises = [...workoutDays[dayNum].exercises];
                // For numeric fields, allow empty string temporarily so user can clear and retype
                const processedValue = (field === 'sets' || field === 'minReps' || field === 'maxReps' || field === 'minutes' || field === 'seconds')
                    ? (value === '' ? '' : (parseInt(value) || 0))
                    : value;

                updatedExercises[exerciseIndex] = {
                    ...updatedExercises[exerciseIndex],
                    [field]: processedValue
                };
                setWorkoutDays({
                    ...workoutDays,
                    [dayNum]: {
                        ...workoutDays[dayNum],
                        exercises: updatedExercises
                    }
                });
            };

            const removeExercise = (dayNum, index) => {
                setWorkoutDays({
                    ...workoutDays,
                    [dayNum]: {
                        ...workoutDays[dayNum],
                        exercises: workoutDays[dayNum].exercises.filter((_, i) => i !== index)
                    }
                });
            };

            const moveExercise = (dayNum, exerciseIndex, direction) => {
                const exercises = workoutDays[dayNum].exercises;

                // Prevent moving beyond boundaries
                if (direction === 'up' && exerciseIndex === 0) return;
                if (direction === 'down' && exerciseIndex === exercises.length - 1) return;

                // Calculate new index
                const newIndex = direction === 'up' ? exerciseIndex - 1 : exerciseIndex + 1;

                // Create a copy and swap exercises
                const reordered = [...exercises];
                [reordered[exerciseIndex], reordered[newIndex]] = [reordered[newIndex], reordered[exerciseIndex]];

                // Update state with reordered exercises
                setWorkoutDays({
                    ...workoutDays,
                    [dayNum]: {
                        ...workoutDays[dayNum],
                        exercises: reordered
                    }
                });
            };

            const hasAtLeastOneExercise = Object.values(workoutDays).some(day => day.exercises.length > 0);
            const allDaysHaveExercises = Object.values(workoutDays).every(day => day.exercises.length > 0);

            const validateExercises = () => {
                const errors = {};

                Object.entries(workoutDays).forEach(([dayNum, dayData]) => {
                    dayData.exercises.forEach((ex, idx) => {
                        if (ex.isCardio) {
                            if (!ex.intensity || ex.intensity.trim() === '') {
                                const errorKey = `${dayNum}-${idx}-intensity`;
                                errors[errorKey] = 'Intensity is required for cardio exercises';
                            }
                            if (!ex.minutes || ex.minutes === 0) {
                                const errorKey = `${dayNum}-${idx}-minutes`;
                                errors[errorKey] = 'Minutes is required for cardio exercises';
                            }
                        }
                    });
                });

                return errors;
            };

            const handleContinue = () => {
                const errors = validateExercises();
                setValidationErrors(errors);

                if (Object.keys(errors).length > 0) {
                    // Find first day with errors and switch to it
                    const firstErrorKey = Object.keys(errors)[0];
                    const dayNum = parseInt(firstErrorKey.split('-')[0]);
                    setSelectedDay(dayNum);
                    return;
                }

                if (allDaysHaveExercises) {
                    onNext(workoutDays);
                } else {
                    // Find first day without exercises and switch to it
                    const emptyDay = Object.keys(workoutDays).find(dayNum => workoutDays[dayNum].exercises.length === 0);
                    if (emptyDay) {
                        setSelectedDay(parseInt(emptyDay));
                    }
                }
            };

            const dayLabels = schedule.workoutDays
                .filter(d => d.workoutDayNumber === selectedDay)
                .map(d => d.dayOfWeek.substring(0, 3))
                .join('/');

            return (
                <>
                    <div className="wizard-header">
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px' }}>
                            <h1 className="wizard-title" style={{ margin: 0 }}>Build Your Workouts</h1>
                            <button
                                onClick={() => setShowExample(true)}
                                style={{
                                    background: 'linear-gradient(135deg, #3a2a5a, #4a3a6a)',
                                    border: '2px solid #5a4a7a',
                                    borderRadius: '50%',
                                    width: '32px',
                                    height: '32px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    cursor: 'pointer',
                                    fontSize: '18px',
                                    color: '#b8b8d0',
                                    fontWeight: 'bold',
                                    boxShadow: '0 2px 8px rgba(58, 42, 90, 0.4)',
                                    transition: 'all 0.2s ease'
                                }}
                                onMouseEnter={(e) => {
                                    e.target.style.background = 'linear-gradient(135deg, #4a3a6a, #5a4a7a)';
                                    e.target.style.transform = 'scale(1.05)';
                                }}
                                onMouseLeave={(e) => {
                                    e.target.style.background = 'linear-gradient(135deg, #3a2a5a, #4a3a6a)';
                                    e.target.style.transform = 'scale(1)';
                                }}
                                title="Show example"
                            >
                                ?
                            </button>
                        </div>
                        <p className="wizard-subtitle">Name each day and add exercises</p>
                    </div>

                    <div className="wizard-progress">
                        <div className="wizard-progress-dot completed"></div>
                        <div className="wizard-progress-dot completed"></div>
                        <div className="wizard-progress-dot active"></div>
                        <div className="wizard-progress-dot"></div>
                    </div>

                    <div className="wizard-content" style={{ maxWidth: '800px', margin: '0 auto', padding: '20px' }}>
                                {/* Day selector tabs */}
                                <div className="workout-day-selector" style={{ display: 'flex', gap: '8px', marginBottom: '20px', flexWrap: 'wrap' }}>
                                    {uniqueDays.map(dayNum => {
                                        const labels = schedule.workoutDays
                                            .filter(d => d.workoutDayNumber === dayNum)
                                            .map(d => d.dayOfWeek.substring(0, 3))
                                            .join('/');
                                        return (
                                            <button
                                                key={dayNum}
                                                onClick={() => setSelectedDay(dayNum)}
                                                style={{
                                                    flex: 1,
                                                    minWidth: '100px',
                                                    padding: '12px',
                                                    background: selectedDay === dayNum ? '#3a2a5a' : '#1a1a2a',
                                                    border: `2px solid ${selectedDay === dayNum ? '#4a3a6a' : '#2a2a3a'}`,
                                                    borderRadius: '8px',
                                                    color: '#b8b8d0',
                                                    fontSize: '14px',
                                                    fontWeight: 600,
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                {labels}
                                            </button>
                                        );
                                    })}
                                </div>

                                {/* Day name input */}
                                {currentDay && (
                                    <div style={{ marginBottom: '20px' }}>
                                        <label style={{ display: 'block', fontSize: '12px', color: '#6a5a8a', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                                            Name this day (e.g., "Push", "Upper", "Chest & Back")
                                        </label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            value={currentDay.name}
                                            onChange={(e) => updateDayName(selectedDay, e.target.value)}
                                            placeholder="Day name..."
                                            style={{ marginBottom: 0 }}
                                        />
                                    </div>
                                )}

                                {/* Exercise list */}
                                {currentDay && (
                                    <div style={{ marginBottom: '20px' }}>
                                        <div style={{ fontSize: '12px', color: '#6a5a8a', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                                            Exercises ({currentDay.exercises.length})
                                        </div>
                                        {/* Column headers */}
                                        {currentDay.exercises.length > 0 && (
                                            <div style={{ display: 'flex', gap: '8px', alignItems: 'center', padding: '6px 8px', marginBottom: '6px' }}>
                                                <span style={{ minWidth: '160px', flex: '0 0 auto', fontSize: '11px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Exercise Name</span>
                                            </div>
                                        )}
                                        <div style={{ background: '#1a1a2a', borderRadius: '8px', padding: '12px', minHeight: '100px' }}>
                                            {currentDay.exercises.length === 0 && (
                                                <div style={{ textAlign: 'center', color: '#666', padding: '20px' }}>
                                                    Start typing your exercises to see common exercises, or create your own
                                                </div>
                                            )}
                                            {currentDay.exercises.map((ex, idx) => (
                                                <div key={idx} className="wizard-exercise-row" style={{ padding: '8px', background: '#0d0d1a', borderRadius: '4px', marginBottom: '6px' }}>
                                                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center', justifyContent: 'space-between', marginBottom: '0' }}>
                                                        <span style={{ color: '#b8b8d0', flex: '1' }}>{idx + 1}. {ex.name}</span>
                                                        <button
                                                            onClick={() => moveExercise(selectedDay, idx, 'up')}
                                                            disabled={idx === 0}
                                                            style={{
                                                                padding: '4px 8px',
                                                                background: idx === 0 ? '#0d0d1a' : '#1a1a2a',
                                                                border: '1px solid #2a2a3a',
                                                                borderRadius: '4px',
                                                                color: idx === 0 ? '#555' : '#8a8aa0',
                                                                cursor: idx === 0 ? 'not-allowed' : 'pointer',
                                                                fontSize: '14px'
                                                            }}
                                                            title="Move up"
                                                        >
                                                            ‚Üë
                                                        </button>
                                                        <button
                                                            onClick={() => moveExercise(selectedDay, idx, 'down')}
                                                            disabled={idx === currentDay.exercises.length - 1}
                                                            style={{
                                                                padding: '4px 8px',
                                                                background: idx === currentDay.exercises.length - 1 ? '#0d0d1a' : '#1a1a2a',
                                                                border: '1px solid #2a2a3a',
                                                                borderRadius: '4px',
                                                                color: idx === currentDay.exercises.length - 1 ? '#555' : '#8a8aa0',
                                                                cursor: idx === currentDay.exercises.length - 1 ? 'not-allowed' : 'pointer',
                                                                fontSize: '14px'
                                                            }}
                                                            title="Move down"
                                                        >
                                                            ‚Üì
                                                        </button>
                                                        <button
                                                            onClick={() => removeExercise(selectedDay, idx)}
                                                            style={{ background: 'none', border: 'none', color: '#8a5a5a', cursor: 'pointer', fontSize: '18px' }}
                                                            title="Remove exercise"
                                                        >
                                                            √ó
                                                        </button>
                                                    </div>
                                                    <div className="wizard-exercise-inputs" style={{ display: 'flex', gap: '8px', alignItems: 'flex-end' }}>
                                                        {ex.isCardio ? (
                                                            <>
                                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                                                    <span style={{ fontSize: '10px', color: validationErrors[`${selectedDay}-${idx}-intensity`] ? '#ff5555' : '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Intensity</span>
                                                                    <input
                                                                        type="text"
                                                                        value={ex.intensity || ''}
                                                                        onChange={(e) => {
                                                                            updateExerciseField(selectedDay, idx, 'intensity', e.target.value);
                                                                            // Clear validation error when user types
                                                                            if (validationErrors[`${selectedDay}-${idx}-intensity`]) {
                                                                                const newErrors = { ...validationErrors };
                                                                                delete newErrors[`${selectedDay}-${idx}-intensity`];
                                                                                setValidationErrors(newErrors);
                                                                            }
                                                                        }}
                                                                        placeholder="Level 7"
                                                                        style={{
                                                                            width: '100px',
                                                                            padding: '6px',
                                                                            background: '#1a1a2a',
                                                                            border: validationErrors[`${selectedDay}-${idx}-intensity`] ? '2px solid #ff5555' : '2px solid #2a2a3a',
                                                                            borderRadius: '4px',
                                                                            color: '#b8b8d0',
                                                                            fontSize: '14px',
                                                                            textAlign: 'center',
                                                                            boxSizing: 'border-box'
                                                                        }}
                                                                        title="Intensity"
                                                                    />
                                                                </div>
                                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                                                    <span style={{ fontSize: '10px', color: validationErrors[`${selectedDay}-${idx}-minutes`] ? '#ff5555' : '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Minutes</span>
                                                                    <input
                                                                        type="number"
                                                                        value={ex.minutes === '' ? '' : (ex.minutes || 0)}
                                                                        onChange={(e) => {
                                                                            updateExerciseField(selectedDay, idx, 'minutes', e.target.value);
                                                                            // Clear validation error when user types
                                                                            if (validationErrors[`${selectedDay}-${idx}-minutes`]) {
                                                                                const newErrors = { ...validationErrors };
                                                                                delete newErrors[`${selectedDay}-${idx}-minutes`];
                                                                                setValidationErrors(newErrors);
                                                                            }
                                                                        }}
                                                                        placeholder="0"
                                                                        min="0"
                                                                        style={{
                                                                            width: '50px',
                                                                            padding: '6px',
                                                                            background: '#1a1a2a',
                                                                            border: validationErrors[`${selectedDay}-${idx}-minutes`] ? '2px solid #ff5555' : '2px solid #2a2a3a',
                                                                            borderRadius: '4px',
                                                                            color: '#b8b8d0',
                                                                            fontSize: '14px',
                                                                            textAlign: 'center',
                                                                            boxSizing: 'border-box'
                                                                        }}
                                                                        title="Minutes"
                                                                    />
                                                                </div>
                                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                                                    <span style={{ fontSize: '10px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Seconds</span>
                                                                    <input
                                                                        type="number"
                                                                        value={ex.seconds === '' ? '' : (ex.seconds || 0)}
                                                                        onChange={(e) => updateExerciseField(selectedDay, idx, 'seconds', e.target.value)}
                                                                        placeholder="0"
                                                                        min="0"
                                                                        max="59"
                                                                        style={{
                                                                            width: '50px',
                                                                            padding: '6px',
                                                                            background: '#1a1a2a',
                                                                            border: '2px solid #2a2a3a',
                                                                            borderRadius: '4px',
                                                                            color: '#b8b8d0',
                                                                            fontSize: '14px',
                                                                            textAlign: 'center',
                                                                            boxSizing: 'border-box'
                                                                        }}
                                                                        title="Seconds"
                                                                    />
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                                                    <span style={{ fontSize: '10px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Sets</span>
                                                                    <input
                                                                        type="number"
                                                                        value={ex.sets === '' ? '' : (ex.sets || 3)}
                                                                        onChange={(e) => updateExerciseField(selectedDay, idx, 'sets', e.target.value)}
                                                                        placeholder="Sets"
                                                                        style={{
                                                                            width: '60px',
                                                                            padding: '6px',
                                                                            background: '#1a1a2a',
                                                                            border: '2px solid #2a2a3a',
                                                                            borderRadius: '4px',
                                                                            color: '#b8b8d0',
                                                                            fontSize: '14px',
                                                                            textAlign: 'center',
                                                                            boxSizing: 'border-box'
                                                                        }}
                                                                        title="Sets"
                                                                    />
                                                                </div>
                                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                                                    <span style={{ fontSize: '10px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Min</span>
                                                                    <input
                                                                        type="number"
                                                                        value={ex.minReps === '' ? '' : (ex.minReps || 8)}
                                                                        onChange={(e) => updateExerciseField(selectedDay, idx, 'minReps', e.target.value)}
                                                                        placeholder="Min"
                                                                        style={{
                                                                            width: '60px',
                                                                            padding: '6px',
                                                                            background: '#1a1a2a',
                                                                            border: '2px solid #2a2a3a',
                                                                            borderRadius: '4px',
                                                                            color: '#b8b8d0',
                                                                            fontSize: '14px',
                                                                            textAlign: 'center',
                                                                            boxSizing: 'border-box'
                                                                        }}
                                                                        title="Minimum Reps"
                                                                    />
                                                                </div>
                                                                <span style={{ color: '#6a5a8a', paddingBottom: '6px' }}>-</span>
                                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                                                    <span style={{ fontSize: '10px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Max</span>
                                                                    <input
                                                                        type="number"
                                                                        value={ex.maxReps === '' ? '' : (ex.maxReps || 12)}
                                                                        onChange={(e) => updateExerciseField(selectedDay, idx, 'maxReps', e.target.value)}
                                                                        placeholder="Max"
                                                                        style={{
                                                                            width: '60px',
                                                                            padding: '6px',
                                                                            background: '#1a1a2a',
                                                                            border: '2px solid #2a2a3a',
                                                                            borderRadius: '4px',
                                                                            color: '#b8b8d0',
                                                                            fontSize: '14px',
                                                                            textAlign: 'center',
                                                                            boxSizing: 'border-box'
                                                                        }}
                                                                        title="Maximum Reps"
                                                                    />
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Exercise input with dropdown */}
                                {currentDay && (
                                    <div style={{ marginBottom: '20px' }}>
                                        <label style={{ display: 'block', fontSize: '12px', color: '#6a5a8a', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                                            Add Exercise
                                        </label>
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <div style={{ flex: 1, position: 'relative' }}>
                                                <input
                                                    type="text"
                                                    list="exercise-suggestions"
                                                    className="input-field"
                                                    value={customExercise}
                                                    onChange={(e) => setCustomExercise(e.target.value)}
                                                    onKeyPress={(e) => e.key === 'Enter' && addExercise(customExercise)}
                                                    placeholder="Type or select exercise..."
                                                    style={{ marginBottom: 0 }}
                                                />
                                                <datalist id="exercise-suggestions">
                                                    {EXERCISE_WORD_BANK.map((exercise, idx) => (
                                                        <option key={idx} value={exercise} />
                                                    ))}
                                                </datalist>
                                            </div>
                                            <button
                                                onClick={() => addExercise(customExercise)}
                                                className="log-btn"
                                                disabled={!customExercise.trim()}
                                                style={{ padding: '12px 20px', width: 'auto' }}
                                            >
                                                Add
                                            </button>
                                        </div>
                                    </div>
                                )}
                    </div>

                    <div className="wizard-buttons">
                        <button className="wizard-btn secondary" onClick={onBack}>Back</button>
                        <button className="wizard-btn" onClick={handleContinue} disabled={!hasAtLeastOneExercise}>
                            Continue
                        </button>
                    </div>

                    {/* Example Modal */}
                    {showExample && (
                        <div className="modal-overlay" onClick={() => setShowExample(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '600px' }}>
                                <div className="modal-title">How It Works</div>
                                <div style={{ marginBottom: '20px' }}>
                                    <p style={{ color: '#b8b8d0', marginBottom: '16px', lineHeight: '1.6' }}>
                                        Name each workout day and add your exercises with target sets and rep ranges. Here's an example:
                                    </p>

                                    <div style={{ background: '#1a1a2a', borderRadius: '8px', padding: '16px', marginBottom: '16px' }}>
                                        <label style={{ display: 'block', fontSize: '12px', color: '#6a5a8a', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                                            Name this day (e.g., "Push", "Upper", "Chest & Back")
                                        </label>
                                        <div style={{ padding: '12px', background: '#0d0d1a', border: '1px solid #2a2a3a', borderRadius: '4px', color: '#b8b8d0', fontWeight: 600 }}>
                                            Push
                                        </div>
                                    </div>

                                    <div style={{ background: '#1a1a2a', borderRadius: '8px', padding: '16px' }}>
                                        <div style={{ fontSize: '12px', color: '#6a5a8a', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                                            Exercises (1)
                                        </div>
                                        <div style={{ display: 'flex', gap: '8px', alignItems: 'center', padding: '6px 8px', marginBottom: '6px' }}>
                                            <span style={{ minWidth: '160px', flex: '0 0 auto', fontSize: '11px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Exercise Name</span>
                                            <span style={{ width: '60px', fontSize: '11px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Sets</span>
                                            <span style={{ width: '60px', fontSize: '11px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Min</span>
                                            <span style={{ width: '10px' }}></span>
                                            <span style={{ width: '60px', fontSize: '11px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Max</span>
                                        </div>
                                        <div style={{ background: '#0d0d1a', borderRadius: '4px', padding: '12px' }}>
                                            <div style={{ display: 'flex', gap: '8px', alignItems: 'center', padding: '8px', background: '#050510', borderRadius: '4px' }}>
                                                <span style={{ color: '#b8b8d0', minWidth: '160px', flex: '0 0 auto', fontWeight: 600 }}>1. Bench Press</span>
                                                <div style={{ width: '60px', padding: '6px', background: '#1a1a2a', border: '1px solid #2a2a3a', borderRadius: '4px', color: '#b8b8d0', fontSize: '14px', textAlign: 'center', fontWeight: 600 }}>3</div>
                                                <div style={{ width: '60px', padding: '6px', background: '#1a1a2a', border: '1px solid #2a2a3a', borderRadius: '4px', color: '#b8b8d0', fontSize: '14px', textAlign: 'center', fontWeight: 600 }}>8</div>
                                                <span style={{ color: '#6a5a8a' }}>-</span>
                                                <div style={{ width: '60px', padding: '6px', background: '#1a1a2a', border: '1px solid #2a2a3a', borderRadius: '4px', color: '#b8b8d0', fontSize: '14px', textAlign: 'center', fontWeight: 600 }}>12</div>
                                            </div>
                                        </div>
                                    </div>

                                    <p style={{ color: '#8a8aa0', marginTop: '16px', fontSize: '14px', fontStyle: 'italic' }}>
                                        This means: 3 sets of Bench Press, aiming for 8-12 reps per set.
                                    </p>
                                </div>

                                <button className="modal-btn" onClick={() => setShowExample(false)}>
                                    Got it!
                                </button>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        function ConfirmStep({ schedule, workoutDays, onComplete, onBack }) {
            const uniqueDays = Array.from(new Set(schedule.workoutDays.map(d => d.workoutDayNumber))).sort();
            const totalExercises = Object.values(workoutDays).reduce((sum, day) => sum + day.exercises.length, 0);

            return (
                <>
                    <div className="wizard-header">
                        <div className="wizard-icon">üéâ</div>
                        <h1 className="wizard-title">You're All Set!</h1>
                        <p className="wizard-subtitle">Here's your program summary</p>
                    </div>

                    <div className="wizard-progress">
                        <div className="wizard-progress-dot completed"></div>
                        <div className="wizard-progress-dot completed"></div>
                        <div className="wizard-progress-dot completed"></div>
                        <div className="wizard-progress-dot active"></div>
                    </div>

                    <div className="wizard-content">
                        <div className="summary-section">
                            <div className="summary-label">Workout Days</div>
                            <div className="summary-value">{schedule.workoutDays.length} days per week</div>
                            <div style={{ fontSize: '14px', color: '#8a8aa0', marginTop: '4px' }}>
                                {schedule.workoutDays.map(d => {
                                    const dayName = workoutDays[d.workoutDayNumber]?.name || `Day ${d.workoutDayNumber}`;
                                    return `${d.dayOfWeek.substring(0, 3)} (${dayName})`;
                                }).join(', ')}
                            </div>
                        </div>

                        <div className="summary-section">
                            <div className="summary-label">Your Workouts</div>
                            {uniqueDays.map(dayNum => {
                                const day = workoutDays[dayNum];
                                return (
                                    <div key={dayNum} style={{ marginTop: '12px' }}>
                                        <div style={{ fontSize: '14px', fontWeight: 600, color: '#b8b8d0' }}>
                                            {day.name}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#8a8aa0' }}>
                                            {day.exercises.length} exercise{day.exercises.length !== 1 ? 's' : ''}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="summary-section">
                            <div className="summary-label">Total Exercises</div>
                            <div className="summary-value">{totalExercises} exercises</div>
                        </div>

                        <div style={{ fontSize: '14px', color: '#6a5a8a', marginTop: '20px', lineHeight: '1.6' }}>
                            You can customize exercise order and exercise names anytime in Settings ‚öôÔ∏è
                        </div>
                    </div>

                    <div className="wizard-buttons">
                        <button className="wizard-btn secondary" onClick={onBack}>Back</button>
                        <button className="wizard-btn" onClick={onComplete}>Start Tracking!</button>
                    </div>
                </>
            );
        }

        // ============================================================================
        // MIGRATION FUNCTIONS
        // ============================================================================

        function migrateExerciseConfig() {
            const oldConfig = storage.getItem('gymExerciseConfig');
            if (!oldConfig) return;

            const config = JSON.parse(oldConfig);
            if (config.version === 2) return; // Already migrated

            // Transform old format to new
            const newConfig = {
                version: 2,
                days: {
                    1: config.day1 || [],
                    2: config.day2 || []
                },
                categories: config.categories || []
            };

            storage.setItem('gymExerciseConfig', JSON.stringify(newConfig));
        }

        function migrateWorkoutHistory() {
            const history = storage.getItem('gymWorkoutHistory');
            if (!history) return;

            const workouts = JSON.parse(history);
            if (workouts.length === 0) return;
            if (workouts[0].dayOfWeek) return; // Already migrated

            const migratedHistory = workouts.map(workout => {
                const date = new Date(workout.date);
                const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' });

                // Migrate exercise format
                const migratedExercises = workout.exercises.map(ex => {
                    const values = {};
                    if (ex.weight) values.weight = ex.weight;
                    if (ex.reps) values.reps = ex.reps;
                    if (ex.rounds) values.rounds = ex.rounds;
                    if (ex.time) values.time = ex.time;
                    if (ex.level) values.level = ex.level;

                    return {
                        id: ex.id,
                        name: ex.name,
                        category: ex.category,
                        typeId: ex.type || 'standard', // Rename type ‚Üí typeId
                        values: values,
                        order: ex.order
                    };
                });

                return {
                    date: workout.date,
                    dayOfWeek: dayOfWeek,
                    workoutDayNumber: workout.day, // Rename day ‚Üí workoutDayNumber
                    week: workout.week,
                    exercises: migratedExercises,
                    submitted: workout.submitted
                };
            });

            storage.setItem('gymWorkoutHistory', JSON.stringify(migratedHistory));
        }

        function createDefaultSchedule() {
            // Create a 2-day alternating schedule to preserve old behavior
            const defaultSchedule = {
                version: 2,
                workoutDays: [
                    { dayOfWeek: 'Monday', workoutDayNumber: 1 },
                    { dayOfWeek: 'Wednesday', workoutDayNumber: 2 },
                    { dayOfWeek: 'Friday', workoutDayNumber: 1 },
                    { dayOfWeek: 'Saturday', workoutDayNumber: 2 }
                ],
                totalWorkoutDays: 2
            };

            storage.setItem('gymScheduleConfig', JSON.stringify(defaultSchedule));
        }

        // ============================================================================
        // APP COMPONENT
        // ============================================================================

        function App() {
            const [currentView, setCurrentView] = useState('workout');
            const [currentDay, setCurrentDay] = useState(1);
            const [workoutData, setWorkoutData] = useState({});
            const [loggedExercises, setLoggedExercises] = useState({});
            const [workoutHistory, setWorkoutHistory] = useState([]);
            const [showSuccess, setShowSuccess] = useState(false);
            const [successMessage, setSuccessMessage] = useState('');
            const [exercisesByDay, setExercisesByDay] = useState({});
            const [schedule, setSchedule] = useState(null);
            const [exerciseCategories, setExerciseCategories] = useState([]);
            const [selectedExercise, setSelectedExercise] = useState('');
            const [celebration, setCelebration] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [showBackupReminder, setShowBackupReminder] = useState(false);
            const [showTutorial, setShowTutorial] = useState(false);
            const [showDayBreakdown, setShowDayBreakdown] = useState(false);
            const [showEditWorkout, setShowEditWorkout] = useState(false);
            const [editingWorkout, setEditingWorkout] = useState(null);
            const [viewingWeek, setViewingWeek] = useState(1);
            const [showWizard, setShowWizard] = useState(false);
            const [fieldErrors, setFieldErrors] = useState({});
            const currentWeek = useMemo(() => getCurrentWeek(workoutHistory), [workoutHistory]);
            const hasMigratedWeeks = useRef(false);

            useEffect(() => {
                // Migrate existing data to namespaced storage (one-time for existing users)
                migrateToNamespacedStorage();

                // Check if setup is completed
                const setupCompleted = storage.getItem('gymSetupCompleted');

                if (!setupCompleted) {
                    // Check if user has existing data
                    const hasHistory = storage.getItem('gymWorkoutHistory');
                    const hasConfig = storage.getItem('gymExerciseConfig');

                    if (hasHistory || hasConfig) {
                        // Existing user - auto-migrate
                        migrateExerciseConfig();
                        migrateWorkoutHistory();
                        createDefaultSchedule();

                        // Mark setup as completed
                        storage.setItem('gymSetupCompleted', JSON.stringify({
                            version: 1,
                            completed: true,
                            completedAt: new Date().toISOString(),
                            migrated: true
                        }));
                    } else {
                        // New user - show wizard
                        setShowWizard(true);
                        return; // Don't load data yet
                    }
                }

                // Load workout history
                const saved = storage.getItem('gymWorkoutHistory');
                if (saved) {
                    const history = JSON.parse(saved);
                    setWorkoutHistory(history);
                }

                // Load workout schedule
                const savedSchedule = storage.getItem('gymScheduleConfig');
                if (savedSchedule) {
                    setSchedule(JSON.parse(savedSchedule));
                }

                // Load custom exercise configurations
                const savedExercises = storage.getItem('gymExerciseConfig');
                if (savedExercises) {
                    const config = JSON.parse(savedExercises);

                    // Check for version 2 format (from wizard)
                    if (config.version === 2 && config.days) {
                        // Sort exercises in each day by order
                        const sortedDays = {};
                        Object.keys(config.days).forEach(dayNum => {
                            sortedDays[dayNum] = config.days[dayNum].sort((a, b) => a.order - b.order);
                        });
                        setExercisesByDay(sortedDays);

                        // Set first exercise as selected for progress view
                        const allExercises = Object.values(sortedDays).flat();
                        if (allExercises.length > 0 && !selectedExercise) {
                            setSelectedExercise(allExercises[0].id);
                        }

                        if (config.categories) {
                            setExerciseCategories(config.categories);
                        }
                    }
                    // Fallback to old format for backward compatibility
                    else if (config.day1 || config.day2) {
                        const days = {};
                        if (config.day1) {
                            days[1] = config.day1.sort((a, b) => a.order - b.order);
                        }
                        if (config.day2) {
                            days[2] = config.day2.sort((a, b) => a.order - b.order);
                        }
                        setExercisesByDay(days);

                        // Set first exercise as selected for progress view
                        const allExercises = Object.values(days).flat();
                        if (allExercises.length > 0 && !selectedExercise) {
                            setSelectedExercise(allExercises[0].id);
                        }
                    }
                }

                // Check last backup reminder
                const lastReminder = storage.getItem('lastBackupReminder');
                const now = new Date().getTime();
                const oneMonth = 30 * 24 * 60 * 60 * 1000;

                if (!lastReminder || (now - parseInt(lastReminder)) > oneMonth) {
                    setShowBackupReminder(true);
                }
            }, []);

            // Update viewing week and migrate workout history when it loads
            useEffect(() => {
                if (workoutHistory.length > 0 && !hasMigratedWeeks.current) {
                    // Clear the cached first workout Monday to recalculate based on actual data
                    storage.removeItem('firstWorkoutMonday');

                    // Recalculate and migrate week numbers for all workouts
                    const migratedHistory = workoutHistory.map(workout => ({
                        ...workout,
                        week: getWeekNumber(workout.date, workoutHistory)
                    }));

                    // Only update if week numbers actually changed
                    const hasChanges = migratedHistory.some((workout, idx) =>
                        workout.week !== workoutHistory[idx].week
                    );

                    if (hasChanges) {
                        setWorkoutHistory(migratedHistory);
                        storage.setItem('gymWorkoutHistory', JSON.stringify(migratedHistory));
                    }

                    // Set viewing week to current week
                    setViewingWeek(currentWeek);

                    // Mark migration as complete
                    hasMigratedWeeks.current = true;
                }
            }, [workoutHistory.length, currentWeek]); // Run when history loads or length changes

            // Set currentDay to first workout day in schedule when loaded
            useEffect(() => {
                if (schedule && schedule.workoutDays && schedule.workoutDays.length > 0) {
                    // Get the first workout day number from the schedule
                    const firstWorkoutDay = schedule.workoutDays[0].workoutDayNumber;
                    setCurrentDay(firstWorkoutDay);
                }
            }, [schedule]);

            // Restore logged state and workout data from today's workout
            useEffect(() => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const todayWorkout = workoutHistory.find(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    return isSameDay && isSameWorkoutDay;
                });

                if (todayWorkout && !todayWorkout.submitted) {
                    // Only restore state if workout hasn't been submitted yet
                    const newLoggedExercises = {};
                    const newWorkoutData = {};

                    todayWorkout.exercises.forEach(exercise => {
                        let hasData = false;

                        if (exercise.type === 'assault-bike') {
                            hasData = exercise.rounds && exercise.rounds.trim() !== '';
                        } else if (exercise.type === 'stairmaster') {
                            hasData = exercise.time && exercise.time.trim() !== '';
                        } else if (exercise.isCardio || exercise.type === 'cardio') {
                            hasData = (exercise.intensity && exercise.intensity.trim() !== '') ||
                                      (exercise.minutes && exercise.minutes > 0) ||
                                      (exercise.seconds && exercise.seconds > 0);
                        } else if (exercise.type === 'bodyweight') {
                            hasData = exercise.reps && exercise.reps.toString().trim() !== '';
                        } else {
                            hasData = (exercise.weight && exercise.weight.toString().trim() !== '') ||
                                      (exercise.reps && exercise.reps.toString().trim() !== '');
                        }

                        if (hasData) {
                            newLoggedExercises[exercise.id] = true;

                            if (exercise.type === 'assault-bike') {
                                newWorkoutData[exercise.id] = { rounds: exercise.rounds };
                            } else if (exercise.type === 'stairmaster') {
                                newWorkoutData[exercise.id] = { time: exercise.time, level: exercise.level || 'Level 7' };
                            } else if (exercise.isCardio || exercise.type === 'cardio') {
                                newWorkoutData[exercise.id] = {
                                    intensity: exercise.intensity,
                                    minutes: exercise.minutes,
                                    seconds: exercise.seconds
                                };
                            } else if (exercise.type === 'bodyweight') {
                                newWorkoutData[exercise.id] = { reps: exercise.reps };
                            } else {
                                newWorkoutData[exercise.id] = {
                                    weight: exercise.weight,
                                    reps: exercise.reps
                                };
                            }
                        }
                    });

                    setLoggedExercises(newLoggedExercises);
                    setWorkoutData(newWorkoutData);
                } else {
                    // Clear logged state if switching to a day with no workout or if workout is submitted
                    setLoggedExercises({});
                    setWorkoutData({});
                }
            }, [workoutHistory, currentDay]);

            const getCurrentExercises = () => {
                return exercisesByDay[currentDay] || [];
            };

            const getTodayWorkout = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return workoutHistory.find(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    return isSameDay && isSameWorkoutDay;
                });
            };

            const isWorkoutSubmitted = () => {
                const todayWorkout = getTodayWorkout();
                return todayWorkout && todayWorkout.submitted;
            };

            const saveExerciseConfig = () => {
                const config = {
                    version: 2,
                    days: exercisesByDay,
                    categories: exerciseCategories
                };
                storage.setItem('gymExerciseConfig', JSON.stringify(config));
            };

            const updateExerciseName = (day, exerciseId, newName, additionalProps = {}) => {
                setExercisesByDay(prev => {
                    const updated = {
                        ...prev,
                        [day]: prev[day].map(ex =>
                            ex.id === exerciseId ? { ...ex, name: newName, ...additionalProps } : ex
                        )
                    };
                    // Save immediately
                    const config = {
                        version: 2,
                        days: updated,
                        categories: exerciseCategories
                    };
                    storage.setItem('gymExerciseConfig', JSON.stringify(config));
                    return updated;
                });
            };

            const moveExercise = (day, exerciseId, direction) => {
                const exercises = exercisesByDay[day] || [];
                const currentIndex = exercises.findIndex(ex => ex.id === exerciseId);

                if (direction === 'up' && currentIndex === 0) return;
                if (direction === 'down' && currentIndex === exercises.length - 1) return;

                const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
                const reordered = [...exercises];
                [reordered[currentIndex], reordered[newIndex]] = [reordered[newIndex], reordered[currentIndex]];

                // Update order values
                const updated = reordered.map((ex, idx) => ({ ...ex, order: idx }));

                setExercisesByDay(prev => {
                    const updatedDays = {
                        ...prev,
                        [day]: updated
                    };
                    // Save immediately
                    const config = {
                        version: 2,
                        days: updatedDays,
                        categories: exerciseCategories
                    };
                    storage.setItem('gymExerciseConfig', JSON.stringify(config));
                    return updatedDays;
                });
            };

            const getPreviousWorkout = (exerciseId) => {
                if (workoutHistory.length === 0) return null;

                // Collect the last 3 sessions that included this exercise (regardless of NA status)
                const lastThreeSessions = [];
                for (let workout of workoutHistory) {
                    const exercise = workout.exercises.find(e => e.id === exerciseId);
                    if (exercise) {
                        lastThreeSessions.push(exercise);
                        if (lastThreeSessions.length >= 3) break;
                    }
                }

                // From those 3, find the most recent one with actual data (non-NA)
                for (let exercise of lastThreeSessions) {
                    let hasData = false;
                    if (exercise.type === 'assault-bike') {
                        hasData = exercise.rounds && exercise.rounds.trim() !== '';
                    } else if (exercise.type === 'stairmaster') {
                        hasData = exercise.time && exercise.time.trim() !== '';
                    } else if (exercise.isCardio || exercise.type === 'cardio') {
                        // For cardio, check that total time is > 0 (not just "0:00")
                        const totalSeconds = ((exercise.minutes || 0) * 60) + (exercise.seconds || 0);
                        hasData = totalSeconds > 0;
                    } else if (exercise.type === 'bodyweight') {
                        hasData = exercise.reps && exercise.reps.toString().trim() !== '';
                    } else {
                        hasData = (exercise.weight && exercise.weight.toString().trim() !== '') ||
                                  (exercise.reps && exercise.reps.toString().trim() !== '');
                    }

                    if (hasData) {
                        return exercise;
                    }
                }

                return null;
            };

            const handleInputChange = (exerciseId, field, value) => {
                setWorkoutData(prev => ({
                    ...prev,
                    [exerciseId]: {
                        ...prev[exerciseId],
                        [field]: value
                    }
                }));

                // Clear validation error for this field when user types
                const errorKey = `${exerciseId}-${field}`;
                if (fieldErrors[errorKey]) {
                    setFieldErrors(prev => {
                        const newErrors = { ...prev };
                        delete newErrors[errorKey];
                        return newErrors;
                    });
                }
            };

            const logExercise = (exerciseId) => {
                const exercise = getCurrentExercises().find(e => e.id === exerciseId);
                let data = workoutData[exerciseId] || {};

                // Capture auto-filled weight if user didn't manually enter it
                if ((exercise.type === 'standard' || (!exercise.type && !exercise.isCardio && exercise.typeId !== 'cardio')) && !data.weight && data.reps) {
                    // Find the weight input field for this exercise and read its displayed value
                    const exerciseCard = document.querySelector(`[data-exercise-id="${exerciseId}"]`);
                    if (exerciseCard) {
                        // Find the weight input (it's the first number input with inputmode="decimal")
                        const weightInput = exerciseCard.querySelector('input[type="number"][inputmode="decimal"]');
                        if (weightInput && weightInput.value) {
                            data = { ...data, weight: weightInput.value };
                        }
                    }
                }

                // Validate data based on exercise type and set field errors
                const errors = {};

                // For standard exercises, validate weight and reps
                if (exercise.type === 'standard' || (!exercise.type && !exercise.isCardio && exercise.typeId !== 'cardio')) {
                    if (!data.weight || data.weight.toString().trim() === '') {
                        errors[`${exerciseId}-weight`] = true;
                    }
                    if (!data.reps || data.reps.toString().trim() === '') {
                        errors[`${exerciseId}-reps`] = true;
                    }

                    // If there are validation errors, set them and return
                    if (Object.keys(errors).length > 0) {
                        setFieldErrors(errors);
                        return;
                    }
                }

                if (exercise.type === 'assault-bike' && !data.rounds) return;
                if (exercise.type === 'stairmaster' && !data.time) return;
                if (exercise.type === 'bodyweight' && !data.reps) return;
                if (exercise.isCardio || exercise.typeId === 'cardio') {
                    // Check if minutes is filled (required)
                    if (!data.minutes || data.minutes === 0) {
                        errors[`${exerciseId}-minutes`] = true;
                        setFieldErrors(errors);
                        return;
                    }

                    // For intensity, check if there's a default available (from previous workout or exercise config)
                    const previous = getPreviousWorkout(exerciseId);
                    const hasIntensity = (data.intensity && data.intensity.trim()) ||
                                        (previous && previous.intensity && previous.intensity.trim()) ||
                                        (exercise.intensity && exercise.intensity.trim());
                    if (!hasIntensity) return;
                }

                let finalData = { ...data };

                const timestamp = new Date().toISOString();
                finalData.timestamp = timestamp;

                // Update workoutData with final data
                setWorkoutData(prev => ({
                    ...prev,
                    [exerciseId]: finalData
                }));

                // Find if there's already a workout for today
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayWeek = getWeekNumber(today, workoutHistory);

                let existingWorkoutIndex = workoutHistory.findIndex(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    const isNotSubmitted = !w.submitted;
                    return isSameDay && isSameWorkoutDay && isNotSubmitted;
                });

                // Create exercise object to save
                let exerciseToSave;
                if (exercise.type === 'assault-bike') {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        intensity: '30/30',
                        rounds: finalData.rounds || ''
                    };
                } else if (exercise.type === 'stairmaster') {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        level: finalData.level || 'Level 7',
                        time: finalData.time || ''
                    };
                } else if (exercise.isCardio || exercise.typeId === 'cardio') {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: 'cardio',
                        isCardio: true,
                        intensity: finalData.intensity !== undefined ? finalData.intensity : (exercise.intensity || ''),
                        minutes: finalData.minutes !== undefined ? finalData.minutes : (exercise.minutes || 0),
                        seconds: finalData.seconds !== undefined ? finalData.seconds : (exercise.seconds || 0)
                    };
                } else if (exercise.type === 'bodyweight') {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        weight: 'Body Weight',
                        reps: finalData.reps || ''
                    };
                } else {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        weight: finalData.weight || '',
                        reps: finalData.reps || ''
                    };
                }

                let updatedHistory;
                if (existingWorkoutIndex !== -1) {
                    // Update existing workout
                    updatedHistory = [...workoutHistory];
                    const workout = updatedHistory[existingWorkoutIndex];
                    const exerciseIndex = workout.exercises.findIndex(e => e.id === exerciseId);

                    if (exerciseIndex !== -1) {
                        workout.exercises[exerciseIndex] = exerciseToSave;
                    } else {
                        workout.exercises.push(exerciseToSave);
                    }

                    workout.date = timestamp; // Update to latest timestamp
                } else {
                    // Create new workout with all exercises initialized to NA
                    const allExercises = getCurrentExercises().map(ex => {
                        if (ex.id === exerciseId) {
                            return exerciseToSave;
                        } else {
                            // Initialize as NA
                            if (ex.type === 'assault-bike') {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    intensity: '30/30',
                                    rounds: ''
                                };
                            } else if (ex.type === 'stairmaster') {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    level: 'Level 7',
                                    time: ''
                                };
                            } else if (ex.isCardio || ex.typeId === 'cardio') {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: 'cardio',
                                    isCardio: true,
                                    intensity: '',
                                    minutes: 0,
                                    seconds: 0
                                };
                            } else if (ex.type === 'bodyweight') {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    weight: 'Body Weight',
                                    reps: ''
                                };
                            } else {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    weight: '',
                                    reps: ''
                                };
                            }
                        }
                    });

                    const newWorkout = {
                        date: timestamp,
                        day: currentDay,
                        week: todayWeek,
                        exercises: allExercises,
                        submitted: false
                    };

                    updatedHistory = [newWorkout, ...workoutHistory];
                }

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));

                setLoggedExercises(prev => ({
                    ...prev,
                    [exerciseId]: true
                }));

                setSuccessMessage('Exercise logged!');
                setShowSuccess(true);
                setTimeout(() => setShowSuccess(false), 2000);
            };

            const completeDay = () => {
                // Find today's workout
                const todayWorkout = getTodayWorkout();

                if (!todayWorkout) {
                    alert('Please log at least one exercise first!');
                    return;
                }

                // Mark workout as submitted (immutable)
                const updatedHistory = workoutHistory.map(w => {
                    if (w === todayWorkout) {
                        return { ...w, submitted: true };
                    }
                    return w;
                });

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));

                // Reset all log states so exercises act like a fresh day
                setLoggedExercises({});
                setWorkoutData({});

                setShowDayBreakdown(true);
            };

            const updateWorkout = (workoutDate, updatedExercises) => {
                const updatedHistory = workoutHistory.map(w => {
                    if (w.date === workoutDate) {
                        return { ...w, exercises: updatedExercises };
                    }
                    return w;
                });

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));
                setSuccessMessage('Workout updated!');
                setShowSuccess(true);
                setTimeout(() => setShowSuccess(false), 2000);
            };

            const exportData = () => {
                const exportObj = {
                    workoutHistory,
                    exerciseConfig: {
                        version: 2,
                        days: exercisesByDay,
                        categories: exerciseCategories
                    },
                    schedule: schedule,
                    exportDate: new Date().toISOString()
                };
                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `gym-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);

                        // Handle old format (just workout history array) or new format (object with configs)
                        if (Array.isArray(imported)) {
                            // Old format
                            setWorkoutHistory(imported);
                            storage.setItem('gymWorkoutHistory', JSON.stringify(imported));
                        } else {
                            // New format
                            if (imported.workoutHistory) {
                                setWorkoutHistory(imported.workoutHistory);
                                storage.setItem('gymWorkoutHistory', JSON.stringify(imported.workoutHistory));
                            }
                            if (imported.schedule) {
                                setSchedule(imported.schedule);
                                storage.setItem('gymScheduleConfig', JSON.stringify(imported.schedule));
                            }
                            if (imported.exerciseConfig) {
                                // Check for version 2 format
                                if (imported.exerciseConfig.version === 2 && imported.exerciseConfig.days) {
                                    const sortedDays = {};
                                    Object.keys(imported.exerciseConfig.days).forEach(dayNum => {
                                        sortedDays[dayNum] = imported.exerciseConfig.days[dayNum].sort((a, b) => a.order - b.order);
                                    });
                                    setExercisesByDay(sortedDays);
                                    if (imported.exerciseConfig.categories) {
                                        setExerciseCategories(imported.exerciseConfig.categories);
                                    }
                                }
                                // Fallback to old format
                                else if (imported.exerciseConfig.day1 || imported.exerciseConfig.day2) {
                                    const days = {};
                                    if (imported.exerciseConfig.day1) {
                                        days[1] = imported.exerciseConfig.day1.sort((a, b) => a.order - b.order);
                                    }
                                    if (imported.exerciseConfig.day2) {
                                        days[2] = imported.exerciseConfig.day2.sort((a, b) => a.order - b.order);
                                    }
                                    setExercisesByDay(days);
                                }
                                storage.setItem('gymExerciseConfig', JSON.stringify(imported.exerciseConfig));
                            }
                        }

                        setSuccessMessage('Data imported successfully!');
                        setShowSuccess(true);
                        setTimeout(() => setShowSuccess(false), 3000);
                        setShowSettings(false);
                    } catch (error) {
                        alert('Invalid backup file');
                    }
                };
                reader.readAsText(file);
            };

            const resetData = () => {
                if (confirm('ARE YOU VERY SURE? This will delete ALL your workout data AND exercise customizations permanently. This cannot be undone!')) {
                    if (confirm('FINAL WARNING: All your progress and custom exercise names/order will be lost forever. Continue?')) {
                        storage.removeItem('gymWorkoutHistory');
                        storage.removeItem('gymExerciseConfig');
                        storage.removeItem('gymScheduleConfig');
                        storage.removeItem('gymSetupCompleted');
                        storage.removeItem('lastBackupReminder');
                        storage.removeItem('hasSeenTutorial');
                        setWorkoutHistory([]);
                        setWorkoutData({});
                        setLoggedExercises({});
                        setExercisesByDay({});
                        setSchedule(null);
                        setExerciseCategories([]);
                        setShowSettings(false);
                        setShowWizard(true); // Show wizard after reset
                    }
                }
            };

            const dismissBackupReminder = () => {
                storage.setItem('lastBackupReminder', new Date().getTime().toString());
                setShowBackupReminder(false);

                // Show tutorial on first time
                const hasSeenTutorial = storage.getItem('hasSeenTutorial');
                if (!hasSeenTutorial) {
                    setShowTutorial(true);
                }
            };

            const dismissTutorial = () => {
                storage.setItem('hasSeenTutorial', 'true');
                setShowTutorial(false);
            };

            return (
                <div className="app">
                    {showWizard && (
                        <SetupWizard
                            onComplete={() => {
                                setShowWizard(false);
                                window.location.reload(); // Reload to load new config
                            }}
                        />
                    )}

                    {showSuccess && <div className={`success-message ${showBackupReminder ? 'backup-reminder' : ''}`}>{successMessage}</div>}
                    {celebration && <Celebration />}

                    {showBackupReminder && (
                        <BackupReminderModal
                            onExport={() => { exportData(); dismissBackupReminder(); }}
                            onDismiss={dismissBackupReminder}
                        />
                    )}

                    {showTutorial && (
                        <TutorialModal onDismiss={dismissTutorial} />
                    )}

                    {showSettings && (
                        <SettingsModal
                            onClose={() => setShowSettings(false)}
                            onExport={exportData}
                            onImport={importData}
                            onReset={resetData}
                            exercisesByDay={exercisesByDay}
                            updateExerciseName={updateExerciseName}
                            moveExercise={moveExercise}
                            schedule={schedule}
                        />
                    )}

                    {showDayBreakdown && (
                        <DayBreakdownModal
                            onClose={() => setShowDayBreakdown(false)}
                            workoutHistory={workoutHistory}
                            currentDay={currentDay}
                            getCurrentExercises={getCurrentExercises}
                            getPreviousWorkout={getPreviousWorkout}
                        />
                    )}

                    {showEditWorkout && editingWorkout && (
                        <EditWorkoutModal
                            workout={editingWorkout}
                            onClose={() => {
                                setShowEditWorkout(false);
                                setEditingWorkout(null);
                            }}
                            onSave={updateWorkout}
                            exercisesByDay={exercisesByDay}
                        />
                    )}

                    <div className="header">
                        <div className="header-top">
                            <h1>Gym Tracker</h1>
                            <button className="settings-btn" onClick={() => setShowSettings(true)}>‚öôÔ∏è</button>
                        </div>
                        <div className="week-indicator">Week {currentWeek}</div>
                        <div className="nav">
                            <button
                                className={`nav-btn ${currentView === 'workout' ? 'active' : ''}`}
                                onClick={() => { window.scrollTo({ top: 0, behavior: 'smooth' }); setCurrentView('workout'); }}
                            >
                                Workout
                            </button>
                            <button
                                className={`nav-btn ${currentView === 'weekly' ? 'active' : ''}`}
                                onClick={() => { setCurrentView('weekly'); setViewingWeek(currentWeek); window.scrollTo(0, 0); }}
                            >
                                Weekly
                            </button>
                            <button
                                className={`nav-btn ${currentView === 'progress' ? 'active' : ''}`}
                                onClick={() => { window.scrollTo({ top: 0, behavior: 'smooth' }); setCurrentView('progress'); }}
                            >
                                Progress
                            </button>
                        </div>
                    </div>

                    <div className="content">
                        {currentView === 'workout' && <WorkoutView
                            currentDay={currentDay}
                            setCurrentDay={setCurrentDay}
                            workoutData={workoutData}
                            loggedExercises={loggedExercises}
                            handleInputChange={handleInputChange}
                            getPreviousWorkout={getPreviousWorkout}
                            logExercise={logExercise}
                            completeDay={completeDay}
                            celebration={celebration}
                            getCurrentExercises={getCurrentExercises}
                            currentWeek={currentWeek}
                            userBodyweight={userBodyweight}
                            schedule={schedule}
                            exercisesByDay={exercisesByDay}
                            fieldErrors={fieldErrors}
                        />}
                        {currentView === 'weekly' && <WeeklyView
                            workoutHistory={workoutHistory}
                            viewingWeek={viewingWeek}
                            setViewingWeek={setViewingWeek}
                            currentWeek={currentWeek}
                            exercisesByDay={exercisesByDay}
                            onEditWorkout={(workout) => {
                                setEditingWorkout(workout);
                                setShowEditWorkout(true);
                            }}
                        />}
                        {currentView === 'progress' && <ProgressView
                            workoutHistory={workoutHistory}
                            selectedExercise={selectedExercise}
                            setSelectedExercise={setSelectedExercise}
                            exercisesByDay={exercisesByDay}
                        />}
                    </div>
                </div>
            );
        }

        function BackupReminderModal({ onExport, onDismiss }) {
            const lastReminder = storage.getItem('lastBackupReminder');
            const isFirstTime = !lastReminder;

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-title">üíæ Backup Reminder</div>
                        <p style={{ color: '#888', marginBottom: '20px', fontSize: '14px', lineHeight: '1.6' }}>
                            {isFirstTime ? (
                                <>
                                    <strong style={{ color: '#b8b8d0' }}>Your data is stored locally on this device.</strong>
                                    <br /><br />
                                    It's a good idea to download your first backup now. You can restore it later by importing the file in Settings ‚öôÔ∏è if you switch devices or clear your browser data.
                                    <br /><br />
                                    You can manually backup anytime in Settings.
                                </>
                            ) : (
                                "It's been a month! Back up your workout data to keep it safe."
                            )}
                        </p>
                        <button className="modal-btn primary" onClick={onExport}>
                            Download Backup
                        </button>
                        <button className="modal-btn" onClick={onDismiss}>
                            Remind Me Later
                        </button>
                    </div>
                </div>
            );
        }

        function TutorialModal({ onDismiss }) {
            return (
                <div className="modal-overlay">
                    <div className="modal" style={{ maxWidth: '500px' }}>

                        {/* Step 1 */}
                        <div style={{ marginBottom: '25px', padding: '20px', background: '#1a1a2a', borderRadius: '12px', border: '2px solid #2a2a3a' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                                <div style={{
                                    background: 'linear-gradient(135deg, #3a2a5a, #4a3a6a)',
                                    borderRadius: '50%',
                                    width: '32px',
                                    height: '32px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: '#fff',
                                    fontWeight: 'bold',
                                    fontSize: '16px'
                                }}>1</div>
                                <div style={{ color: '#b8b8d0', fontWeight: '600', fontSize: '16px' }}>Enter Your Data</div>
                            </div>
                            <div style={{ color: '#8a8aa0', fontSize: '14px', lineHeight: '1.5', paddingLeft: '44px' }}>
                                Fill in the <strong style={{ color: '#b8b8d0' }}>weight and reps</strong> for each exercise you completed.
                            </div>
                        </div>

                        {/* Step 2 */}
                        <div style={{ marginBottom: '25px', padding: '20px', background: '#1a1a2a', borderRadius: '12px', border: '2px solid #2a2a3a' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                                <div style={{
                                    background: 'linear-gradient(135deg, #3a2a5a, #4a3a6a)',
                                    borderRadius: '50%',
                                    width: '32px',
                                    height: '32px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: '#fff',
                                    fontWeight: 'bold',
                                    fontSize: '16px'
                                }}>2</div>
                                <div style={{ color: '#b8b8d0', fontWeight: '600', fontSize: '16px' }}>Tap LOG</div>
                            </div>
                            <div style={{ color: '#8a8aa0', fontSize: '14px', lineHeight: '1.5', paddingLeft: '44px' }}>
                                Press the <strong style={{ color: '#b8b8d0' }}>LOG</strong> button for each exercise to save your set.
                                <div style={{ marginTop: '8px', fontSize: '12px', color: '#6a5a8a' }}>
                                    ‚Ü≥ The button will show <span style={{ color: '#8aaa8a' }}>‚úì Logged</span> when saved
                                </div>
                            </div>
                        </div>

                        {/* Step 3 */}
                        <div style={{ marginBottom: '25px', padding: '20px', background: '#1a1a2a', borderRadius: '12px', border: '2px solid #2a2a3a' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                                <div style={{
                                    background: 'linear-gradient(135deg, #3a2a5a, #4a3a6a)',
                                    borderRadius: '50%',
                                    width: '32px',
                                    height: '32px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: '#fff',
                                    fontWeight: 'bold',
                                    fontSize: '16px'
                                }}>3</div>
                                <div style={{ color: '#b8b8d0', fontWeight: '600', fontSize: '16px' }}>Submit Your Day</div>
                            </div>
                            <div style={{ color: '#8a8aa0', fontSize: '14px', lineHeight: '1.5', paddingLeft: '44px' }}>
                                When you're done logging all exercises, tap <strong style={{ color: '#b8b8d0' }}>Submit Day and View Breakdown</strong> at the bottom.
                                <div style={{ marginTop: '8px', fontSize: '12px', color: '#6a5a8a' }}>
                                    ‚Ü≥ This locks your workout and shows your progress summary
                                </div>
                            </div>
                        </div>


                        <button className="modal-btn primary" onClick={onDismiss} style={{ width: '100%' }}>
                            Got It!
                        </button>
                    </div>
                </div>
            );
        }

        function SettingsModal({ onClose, onExport, onImport, onReset, exercisesByDay, updateExerciseName, moveExercise, schedule }) {
            const fileInputRef = useRef();
            const [settingsView, setSettingsView] = useState('main'); // 'main', 'exercises-1', 'exercises-2', etc.
            const [editingExercise, setEditingExercise] = useState(null);
            const [tempName, setTempName] = useState('');
            const [tempSets, setTempSets] = useState('');
            const [tempMinReps, setTempMinReps] = useState('');
            const [tempMaxReps, setTempMaxReps] = useState('');

            const handleStartEdit = (exercise) => {
                setEditingExercise(exercise.id);
                setTempName(exercise.name);
                setTempSets(exercise.sets || '');
                setTempMinReps(exercise.minReps || '');
                setTempMaxReps(exercise.maxReps || '');
            };

            const handleSaveEdit = (day, exerciseId) => {
                if (tempName.trim()) {
                    updateExerciseName(day, exerciseId, tempName.trim(), {
                        sets: tempSets === '' ? '' : parseInt(tempSets) || 0,
                        minReps: tempMinReps === '' ? '' : parseInt(tempMinReps) || 0,
                        maxReps: tempMaxReps === '' ? '' : parseInt(tempMaxReps) || 0
                    });
                }
                setEditingExercise(null);
                setTempName('');
                setTempSets('');
                setTempMinReps('');
                setTempMaxReps('');
            };

            const handleCancelEdit = () => {
                setEditingExercise(null);
                setTempName('');
                setTempSets('');
                setTempMinReps('');
                setTempMaxReps('');
            };

            if (settingsView.startsWith('exercises-')) {
                const day = parseInt(settingsView.replace('exercises-', ''));
                const exercises = exercisesByDay[day] || [];

                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '500px', maxHeight: '80vh', overflowY: 'auto' }}>
                            <div className="modal-title">Day {day} Exercises</div>

                            <div style={{ marginBottom: '20px' }}>
                                {exercises.map((exercise, idx) => (
                                    <div key={exercise.id} style={{
                                        background: '#1a1a2a',
                                        borderRadius: '8px',
                                        padding: '12px',
                                        marginBottom: '8px',
                                        border: '1px solid #2a2a3a'
                                    }}>
                                        {editingExercise === exercise.id ? (
                                            <div>
                                                <label style={{ display: 'block', fontSize: '11px', color: '#6a5a8a', marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                                    Exercise Name
                                                </label>
                                                <input
                                                    type="text"
                                                    value={tempName}
                                                    onChange={(e) => setTempName(e.target.value)}
                                                    style={{
                                                        width: '100%',
                                                        padding: '8px',
                                                        background: '#0d0d1a',
                                                        border: '1px solid #3a2a5a',
                                                        borderRadius: '4px',
                                                        color: '#b8b8d0',
                                                        marginBottom: '12px',
                                                        boxSizing: 'border-box'
                                                    }}
                                                    autoFocus
                                                />
                                                {!exercise.isCardio && !exercise.type?.includes('bike') && !exercise.type?.includes('stairmaster') && exercise.type !== 'cardio' && exercise.typeId !== 'cardio' && (
                                                    <>
                                                        <label style={{ display: 'block', fontSize: '11px', color: '#6a5a8a', marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                                            Sets & Rep Range Goal
                                                        </label>
                                                        <div style={{ display: 'flex', gap: '8px', alignItems: 'center', marginBottom: '12px' }}>
                                                            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                                                <span style={{ fontSize: '10px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Sets</span>
                                                                <input
                                                                    type="number"
                                                                    value={tempSets}
                                                                    onChange={(e) => setTempSets(e.target.value)}
                                                                    placeholder="3"
                                                                    style={{
                                                                        width: '100%',
                                                                        padding: '8px',
                                                                        background: '#0d0d1a',
                                                                        border: '1px solid #2a2a3a',
                                                                        borderRadius: '4px',
                                                                        color: '#b8b8d0',
                                                                        fontSize: '14px',
                                                                        textAlign: 'center',
                                                                        boxSizing: 'border-box'
                                                                    }}
                                                                />
                                                            </div>
                                                            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                                                <span style={{ fontSize: '10px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Min Reps</span>
                                                                <input
                                                                    type="number"
                                                                    value={tempMinReps}
                                                                    onChange={(e) => setTempMinReps(e.target.value)}
                                                                    placeholder="8"
                                                                    style={{
                                                                        width: '100%',
                                                                        padding: '8px',
                                                                        background: '#0d0d1a',
                                                                        border: '1px solid #2a2a3a',
                                                                        borderRadius: '4px',
                                                                        color: '#b8b8d0',
                                                                        fontSize: '14px',
                                                                        textAlign: 'center',
                                                                        boxSizing: 'border-box'
                                                                    }}
                                                                />
                                                            </div>
                                                            <span style={{ color: '#6a5a8a', paddingTop: '20px' }}>-</span>
                                                            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                                                <span style={{ fontSize: '10px', color: '#6a5a8a', textTransform: 'uppercase', letterSpacing: '0.5px', textAlign: 'center' }}>Max Reps</span>
                                                                <input
                                                                    type="number"
                                                                    value={tempMaxReps}
                                                                    onChange={(e) => setTempMaxReps(e.target.value)}
                                                                    placeholder="12"
                                                                    style={{
                                                                        width: '100%',
                                                                        padding: '8px',
                                                                        background: '#0d0d1a',
                                                                        border: '1px solid #2a2a3a',
                                                                        borderRadius: '4px',
                                                                        color: '#b8b8d0',
                                                                        fontSize: '14px',
                                                                        textAlign: 'center',
                                                                        boxSizing: 'border-box'
                                                                    }}
                                                                />
                                                            </div>
                                                        </div>
                                                    </>
                                                )}
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button
                                                        onClick={() => handleSaveEdit(day, exercise.id)}
                                                        style={{
                                                            flex: 1,
                                                            padding: '8px',
                                                            background: '#3a2a5a',
                                                            border: 'none',
                                                            borderRadius: '4px',
                                                            color: '#b8b8d0',
                                                            cursor: 'pointer',
                                                            fontSize: '14px',
                                                            fontWeight: '600'
                                                        }}
                                                    >
                                                        Save
                                                    </button>
                                                    <button
                                                        onClick={handleCancelEdit}
                                                        style={{
                                                            flex: 1,
                                                            padding: '8px',
                                                            background: '#1a1a2a',
                                                            border: '1px solid #2a2a3a',
                                                            borderRadius: '4px',
                                                            color: '#8a8aa0',
                                                            cursor: 'pointer',
                                                            fontSize: '14px',
                                                            fontWeight: '600'
                                                        }}
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <div style={{ flex: 1, fontWeight: '600' }}>
                                                    {exercise.name}
                                                </div>
                                                <button
                                                    onClick={() => moveExercise(day, exercise.id, 'up')}
                                                    disabled={idx === 0}
                                                    style={{
                                                        padding: '4px 8px',
                                                        background: idx === 0 ? '#0d0d1a' : '#1a1a2a',
                                                        border: '1px solid #2a2a3a',
                                                        borderRadius: '4px',
                                                        color: idx === 0 ? '#555' : '#8a8aa0',
                                                        cursor: idx === 0 ? 'not-allowed' : 'pointer'
                                                    }}
                                                >
                                                    ‚Üë
                                                    </button>
                                                <button
                                                    onClick={() => moveExercise(day, exercise.id, 'down')}
                                                    disabled={idx === exercises.length - 1}
                                                    style={{
                                                        padding: '4px 8px',
                                                        background: idx === exercises.length - 1 ? '#0d0d1a' : '#1a1a2a',
                                                        border: '1px solid #2a2a3a',
                                                        borderRadius: '4px',
                                                        color: idx === exercises.length - 1 ? '#555' : '#8a8aa0',
                                                        cursor: idx === exercises.length - 1 ? 'not-allowed' : 'pointer'
                                                    }}
                                                >
                                                    ‚Üì
                                                </button>
                                                <button
                                                    onClick={() => handleStartEdit(exercise)}
                                                    style={{
                                                        padding: '4px 8px',
                                                        background: '#1a1a2a',
                                                        border: '1px solid #2a2a3a',
                                                        borderRadius: '4px',
                                                        color: '#8a8aa0',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    ‚úèÔ∏è
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>

                            <button className="modal-btn" onClick={() => setSettingsView('main')}>
                                ‚Üê Back to Settings
                            </button>
                        </div>
                    </div>
                );
            }

            const totalWorkoutDays = schedule ? schedule.totalWorkoutDays : Object.keys(exercisesByDay).length;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-title">Settings</div>

                        {Array.from({ length: totalWorkoutDays }, (_, i) => i + 1).map(dayNum => (
                            <button key={dayNum} className="modal-btn" onClick={() => setSettingsView(`exercises-${dayNum}`)}>
                                ‚úèÔ∏è Manage Day {dayNum} Exercises
                            </button>
                        ))}

                        <div style={{ height: '1px', background: '#2a2a3a', margin: '12px 0' }}></div>

                        <button className="modal-btn" onClick={onExport}>
                            üíæ Backup Data (Export)
                        </button>
                        <button className="modal-btn" onClick={() => fileInputRef.current.click()}>
                            üì§ Import Data
                        </button>
                        <button className="modal-btn danger" onClick={onReset}>
                            üóëÔ∏è Reset All Data
                        </button>
                        <input
                            ref={fileInputRef}
                            type="file"
                            accept=".json"
                            className="file-input"
                            onChange={onImport}
                        />
                        <button className="modal-btn" onClick={onClose}>
                            Close
                        </button>
                    </div>
                </div>
            );
        }

        function EditWorkoutModal({ workout, onClose, onSave, exercisesByDay }) {
            const [editedExercises, setEditedExercises] = useState(workout.exercises);
            const allExercises = exercisesByDay[workout.day] || [];

            const handleExerciseChange = (exerciseId, field, value) => {
                setEditedExercises(prev => {
                    const updated = [...prev];
                    const exerciseIndex = updated.findIndex(e => e.id === exerciseId);
                    if (exerciseIndex !== -1) {
                        updated[exerciseIndex] = {
                            ...updated[exerciseIndex],
                            [field]: value
                        };
                    }
                    return updated;
                });
            };

            const handleSave = () => {
                onSave(workout.date, editedExercises);
                onClose();
            };

            const date = new Date(workout.date);
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '600px', maxHeight: '80vh', overflowY: 'auto' }}>
                        <div className="modal-title">Edit Workout - Day {workout.day}</div>
                        <div style={{ marginBottom: '20px', color: '#888', fontSize: '14px' }}>
                            {formattedDate}
                        </div>

                        {allExercises.map((exercise) => {
                            const editedExercise = editedExercises.find(e => e.id === exercise.id);

                            return (
                                <div key={exercise.id} style={{
                                    background: '#1a1a2a',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    marginBottom: '12px',
                                    border: '1px solid #2a2a3a'
                                }}>
                                    <div style={{ fontWeight: '600', marginBottom: '8px' }}>
                                        {exercise.name}
                                    </div>
                                    {exercise.type === 'assault-bike' ? (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="text"
                                                value="30/30"
                                                disabled
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #2a2a3a',
                                                    borderRadius: '4px',
                                                    color: '#666'
                                                }}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Rounds"
                                                value={editedExercise?.rounds || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'rounds', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                        </div>
                                    ) : exercise.type === 'stairmaster' ? (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <select
                                                value={editedExercise?.level || 'Level 7'}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'level', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            >
                                                <option value="Level 7">Level 7</option>
                                                <option value="Level 8">Level 8</option>
                                                <option value="Level 9">Level 9</option>
                                                <option value="Level 10">Level 10</option>
                                            </select>
                                            <select
                                                value={editedExercise?.time || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'time', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            >
                                                <option value="">Select time</option>
                                                {(() => {
                                                    const timeOptions = [];
                                                    for (let minutes = 5; minutes <= 20; minutes++) {
                                                        for (let seconds = 0; seconds < 60; seconds += 15) {
                                                            if (minutes === 20 && seconds > 0) break;
                                                            const time = formatSecondsToTime(minutes * 60 + seconds);
                                                            timeOptions.push(<option key={time} value={time}>{time}</option>);
                                                        }
                                                    }
                                                    return timeOptions;
                                                })()}
                                            </select>
                                        </div>
                                    ) : (exercise.isCardio || exercise.typeId === 'cardio') ? (
                                        <div style={{ display: 'flex', gap: '8px', flexDirection: 'column' }}>
                                            <input
                                                type="text"
                                                placeholder="Intensity"
                                                value={editedExercise?.intensity || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'intensity', e.target.value)}
                                                style={{
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                            <div style={{ display: 'flex', gap: '8px' }}>
                                                <input
                                                    type="number"
                                                    placeholder="Minutes"
                                                    value={editedExercise?.minutes || ''}
                                                    onChange={(e) => handleExerciseChange(exercise.id, 'minutes', e.target.value)}
                                                    min="0"
                                                    style={{
                                                        flex: 1,
                                                        padding: '8px',
                                                        background: '#0d0d1a',
                                                        border: '1px solid #3a2a5a',
                                                        borderRadius: '4px',
                                                        color: '#b8b8d0',
                                                        textAlign: 'center'
                                                    }}
                                                />
                                                <span style={{ color: '#6a5a8a', alignSelf: 'center' }}>:</span>
                                                <input
                                                    type="number"
                                                    placeholder="Seconds"
                                                    value={editedExercise?.seconds || ''}
                                                    onChange={(e) => handleExerciseChange(exercise.id, 'seconds', e.target.value)}
                                                    min="0"
                                                    max="59"
                                                    style={{
                                                        flex: 1,
                                                        padding: '8px',
                                                        background: '#0d0d1a',
                                                        border: '1px solid #3a2a5a',
                                                        borderRadius: '4px',
                                                        color: '#b8b8d0',
                                                        textAlign: 'center'
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    ) : exercise.type === 'bodyweight' ? (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="text"
                                                value="Body Weight"
                                                disabled
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #2a2a3a',
                                                    borderRadius: '4px',
                                                    color: '#666'
                                                }}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Reps"
                                                value={editedExercise?.reps || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'reps', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                        </div>
                                    ) : (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="number"
                                                placeholder="Weight"
                                                value={editedExercise?.weight || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'weight', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Reps"
                                                value={editedExercise?.reps || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'reps', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                        </div>
                                    )}
                                </div>
                            );
                        })}

                        <div style={{ display: 'flex', gap: '8px', marginTop: '20px' }}>
                            <button className="modal-btn primary" onClick={handleSave} style={{ flex: 1 }}>
                                Save Changes
                            </button>
                            <button className="modal-btn" onClick={onClose} style={{ flex: 1 }}>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function DayBreakdownModal({ onClose, workoutHistory, currentDay, getCurrentExercises, getPreviousWorkout }) {
            // Find today's workout
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todayWorkout = workoutHistory.find(w => {
                const workoutDate = new Date(w.date);
                workoutDate.setHours(0, 0, 0, 0);
                const isSameDay = workoutDate.getTime() === today.getTime();
                const isSameWorkoutDay = w.day === currentDay;
                return isSameDay && isSameWorkoutDay;
            });

            if (!todayWorkout) {
                return null;
            }

            // Function to get previous workout excluding today
            const getPreviousWorkoutExcludingToday = (exerciseId) => {
                for (let workout of workoutHistory) {
                    // Skip today's workout
                    const workoutDate = new Date(workout.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    if (workoutDate.getTime() === today.getTime() && workout.day === currentDay) {
                        continue;
                    }

                    const exercise = workout.exercises.find(e => e.id === exerciseId);
                    if (exercise) {
                        // For cardio, check that time is actually > 0 (not just "0:00")
                        if (exercise.isCardio || exercise.type === 'cardio') {
                            const totalSeconds = ((exercise.minutes || 0) * 60) + (exercise.seconds || 0);
                            if (totalSeconds > 0) {
                                return exercise;
                            }
                        } else if (exercise.weight || exercise.reps || exercise.rounds || exercise.time || exercise.intensity) {
                            return exercise;
                        }
                    }
                }
                return null;
            };

            // Get only exercises that match the current day
            const currentDayExerciseIds = new Set(getCurrentExercises().map(e => e.id));
            const currentDayWorkoutExercises = todayWorkout.exercises.filter(e => currentDayExerciseIds.has(e.id));

            // Calculate PRs
            const prs = [];
            currentDayWorkoutExercises.forEach(exercise => {
                // Skip NA exercises - for cardio, check if time is 0:00
                if (exercise.isCardio || exercise.type === 'cardio') {
                    const totalSeconds = ((exercise.minutes || 0) * 60) + (exercise.seconds || 0);
                    if (totalSeconds === 0) {
                        return; // Skip cardio with 0:00
                    }
                } else if (!exercise.weight && !exercise.reps && !exercise.rounds && !exercise.time && !exercise.intensity) {
                    return; // Skip NA exercises
                }

                const previous = getPreviousWorkoutExcludingToday(exercise.id);
                if (!previous) {
                    return; // Skip if no previous workout
                }

                let isPR = false;
                let prType = '';

                if (exercise.type === 'assault-bike') {
                    if (parseInt(exercise.rounds) > parseInt(previous.rounds || 0)) {
                        isPR = true;
                        prType = `${exercise.rounds} rounds (prev: ${previous.rounds})`;
                    }
                } else if (exercise.type === 'stairmaster') {
                    const currentSeconds = parseTimeToSeconds(exercise.time);
                    const previousSeconds = parseTimeToSeconds(previous.time);
                    if (currentSeconds > previousSeconds) {
                        isPR = true;
                        prType = `${exercise.time} (prev: ${previous.time})`;
                    }
                } else if (exercise.isCardio || exercise.type === 'cardio') {
                    const currentTotalSeconds = (parseInt(exercise.minutes) || 0) * 60 + (parseInt(exercise.seconds) || 0);
                    const previousTotalSeconds = (parseInt(previous.minutes) || 0) * 60 + (parseInt(previous.seconds) || 0);
                    if (currentTotalSeconds > previousTotalSeconds) {
                        isPR = true;
                        prType = `${exercise.minutes}:${String(exercise.seconds).padStart(2, '0')} @ ${exercise.intensity} (prev: ${previous.minutes}:${String(previous.seconds).padStart(2, '0')} @ ${previous.intensity})`;
                    }
                } else if (exercise.type === 'bodyweight') {
                    if (parseInt(exercise.reps) > parseInt(previous.reps || 0)) {
                        isPR = true;
                        prType = `${exercise.reps} reps (prev: ${previous.reps})`;
                    }
                } else {
                    // Standard exercise - PR if weight increased or same weight with more reps
                    const currentWeight = parseFloat(exercise.weight);
                    const previousWeight = parseFloat(previous.weight);
                    const currentReps = parseInt(exercise.reps);
                    const previousReps = parseInt(previous.reps);

                    if (currentWeight > previousWeight) {
                        isPR = true;
                        prType = `${exercise.weight}lbs √ó ${exercise.reps} (prev: ${previous.weight}lbs √ó ${previous.reps})`;
                    } else if (currentWeight === previousWeight && currentReps > previousReps) {
                        isPR = true;
                        prType = `${exercise.weight}lbs √ó ${exercise.reps} (prev: ${previous.weight}lbs √ó ${previous.reps})`;
                    }
                }

                if (isPR) {
                    prs.push({
                        name: exercise.name,
                        description: prType
                    });
                }
            });

            // Count completed exercises (only for current day)
            const completedCount = currentDayWorkoutExercises.filter(e => {
                // For cardio, check that time is actually > 0 (not just "0:00")
                if (e.isCardio || e.type === 'cardio') {
                    const totalSeconds = ((e.minutes || 0) * 60) + (e.seconds || 0);
                    return totalSeconds > 0;
                }
                // For other exercise types, check if any data exists
                return e.weight || e.reps || e.rounds || e.time || e.intensity;
            }).length;
            const totalCount = getCurrentExercises().length;

            const date = new Date(todayWorkout.date);
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '500px' }}>
                        <div className="modal-title">Day {currentDay} Breakdown</div>

                        <div style={{ marginBottom: '20px', color: '#888', fontSize: '14px' }}>
                            {formattedDate}
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <div style={{ fontSize: '16px', fontWeight: '600', marginBottom: '10px' }}>
                                Exercises Completed
                            </div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: '#3a2a5a' }}>
                                {completedCount} / {totalCount}
                            </div>
                        </div>


                        <button className="modal-btn primary" onClick={onClose}>
                            Close
                        </button>
                    </div>
                </div>
            );
        }

        function WorkoutView({ currentDay, setCurrentDay, workoutData, loggedExercises, handleInputChange, getPreviousWorkout, logExercise, completeDay, celebration, getCurrentExercises, currentWeek, userBodyweight, schedule, exercisesByDay, fieldErrors }) {
            const exercises = getCurrentExercises();
            const todayDay = getTodayDay();

            // Group exercises by category dynamically
            const exercisesByCategory = {};
            exercises.forEach(exercise => {
                if (!exercisesByCategory[exercise.category]) {
                    exercisesByCategory[exercise.category] = [];
                }
                exercisesByCategory[exercise.category].push(exercise);
            });

            // Get unique categories in order
            const categories = Object.keys(exercisesByCategory);

            const renderExercise = (exercise) => {
                const previous = getPreviousWorkout(exercise.id);
                const isLogged = loggedExercises[exercise.id];
                const data = workoutData[exercise.id] || {};

                if (exercise.type === 'assault-bike') {
                    const isPROpportunity = previous && previous.rounds;
                    const suggestedRounds = isPROpportunity ? (parseInt(previous.rounds) + 1).toString() : null;
                    const isCurrentlyPRAttempt = isPROpportunity && data.rounds &&
                        parseInt(data.rounds) > parseInt(previous.rounds);

                    return (
                        <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                            <div className="exercise-header">
                                <div>
                                    <div className="exercise-name">
                                        {exercise.name}
                                    </div>
                                    {(exercise.sets || exercise.minReps || exercise.maxReps) && (
                                        <div style={{ fontSize: '12px', color: '#8a7aaa', marginTop: '4px', fontStyle: 'italic' }}>
                                            Goal: {exercise.sets || 3} sets √ó {exercise.minReps || 8}-{exercise.maxReps || 12} reps
                                        </div>
                                    )}
                                </div>
                                {previous && (
                                    <div className="previous-data">
                                        Last: {previous.rounds} rounds
                                    </div>
                                )}
                            </div>
                            {isPROpportunity && (
                                <div className="pr-suggestion">
                                    Try {suggestedRounds} rounds for a new PR
                                </div>
                            )}
                            <div className="input-row">
                                <div className="input-group">
                                    <label className="input-label">Intensity</label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value="30/30"
                                        disabled
                                    />
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Rounds</label>
                                    <input
                                        type="number"
                                        inputMode="numeric"
                                        className={`input-field ${isCurrentlyPRAttempt ? 'pr-attempt' : ''}`}
                                        value={data.rounds || ''}
                                        onChange={(e) => handleInputChange(exercise.id, 'rounds', e.target.value)}
                                        placeholder={suggestedRounds || previous?.rounds || '5'}
                                        disabled={isLogged}
                                    />
                                </div>
                            </div>
                            <button
                                className={`log-btn ${isLogged ? 'logged' : ''}`}
                                onClick={() => logExercise(exercise.id)}
                                disabled={isLogged}
                            >
                                {isLogged ? '‚úì Logged' : 'LOG'}
                            </button>
                        </div>
                    );
                }

                if (exercise.type === 'stairmaster') {
                    const isPROpportunity = previous && previous.time;
                    let suggestedTime = null;
                    let suggestedLevel = previous?.level || 'Level 7';
                    if (isPROpportunity) {
                        const prevSeconds = parseTimeToSeconds(previous.time);
                        const newSeconds = prevSeconds + 15;
                        suggestedTime = formatSecondsToTime(newSeconds);
                    }
                    const isCurrentlyPRAttempt = isPROpportunity && data.time &&
                        parseTimeToSeconds(data.time) > parseTimeToSeconds(previous.time);

                    // Generate time options from 5:00 to 20:00 in 15-second increments
                    const timeOptions = [];
                    for (let minutes = 5; minutes <= 20; minutes++) {
                        for (let seconds = 0; seconds < 60; seconds += 15) {
                            if (minutes === 20 && seconds > 0) break; // Stop at 20:00
                            timeOptions.push(formatSecondsToTime(minutes * 60 + seconds));
                        }
                    }

                    return (
                        <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                            <div className="exercise-header">
                                <div>
                                    <div className="exercise-name">
                                        {exercise.name}
                                    </div>
                                    {(exercise.sets || exercise.minReps || exercise.maxReps) && (
                                        <div style={{ fontSize: '12px', color: '#8a7aaa', marginTop: '4px', fontStyle: 'italic' }}>
                                            Goal: {exercise.sets || 3} sets √ó {exercise.minReps || 8}-{exercise.maxReps || 12} reps
                                        </div>
                                    )}
                                </div>
                                {previous && (
                                    <div className="previous-data">
                                        Last: {previous.level || 'Level 7'} - {previous.time}
                                    </div>
                                )}
                            </div>
                            {isPROpportunity && (
                                <div className="pr-suggestion">
                                    Try {suggestedTime} for a new PR
                                </div>
                            )}
                            <div className="input-row">
                                <div className="input-group">
                                    <label className="input-label">Level</label>
                                    <select
                                        className="input-field"
                                        value={data.level || suggestedLevel}
                                        onChange={(e) => handleInputChange(exercise.id, 'level', e.target.value)}
                                        disabled={isLogged}
                                    >
                                        <option value="Level 7">Level 7</option>
                                        <option value="Level 8">Level 8</option>
                                        <option value="Level 9">Level 9</option>
                                        <option value="Level 10">Level 10</option>
                                    </select>
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Time</label>
                                    <select
                                        className={`input-field ${isCurrentlyPRAttempt ? 'pr-attempt' : ''}`}
                                        value={data.time || ''}
                                        onChange={(e) => handleInputChange(exercise.id, 'time', e.target.value)}
                                        disabled={isLogged}
                                    >
                                        <option value="">{suggestedTime || previous?.time || 'Select time'}</option>
                                        {timeOptions.map(time => (
                                            <option key={time} value={time}>{time}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <button
                                className={`log-btn ${isLogged ? 'logged' : ''}`}
                                onClick={() => logExercise(exercise.id)}
                                disabled={isLogged}
                            >
                                {isLogged ? '‚úì Logged' : 'LOG'}
                            </button>
                        </div>
                    );
                }

                if (exercise.type === 'bodyweight') {
                    return (
                        <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                            <div className="exercise-header">
                                <div>
                                    <div className="exercise-name">{exercise.name}</div>
                                    {(exercise.sets || exercise.minReps || exercise.maxReps) && (
                                        <div style={{ fontSize: '12px', color: '#8a7aaa', marginTop: '4px', fontStyle: 'italic' }}>
                                            Goal: {exercise.sets || 3} sets √ó {exercise.minReps || 8}-{exercise.maxReps || 12} reps
                                        </div>
                                    )}
                                </div>
                                {previous && (
                                    <div className="previous-data">
                                        Last: {previous.reps} reps
                                    </div>
                                )}
                            </div>
                            <div className="input-row">
                                <div className="input-group">
                                    <label className="input-label">Weight</label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value="Body Weight"
                                        disabled
                                    />
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Reps on Last Set</label>
                                    <input
                                        type="number"
                                        inputMode="numeric"
                                        className="input-field"
                                        value={data.reps || ''}
                                        onChange={(e) => handleInputChange(exercise.id, 'reps', e.target.value)}
                                        placeholder={previous?.reps || '0'}
                                        disabled={isLogged}
                                    />
                                </div>
                            </div>
                            <button
                                className={`log-btn ${isLogged ? 'logged' : ''}`}
                                onClick={() => logExercise(exercise.id)}
                                disabled={isLogged}
                            >
                                {isLogged ? '‚úì Logged' : 'LOG'}
                            </button>
                        </div>
                    );
                }

                // Cardio exercise (generic cardio type from wizard)
                if (exercise.isCardio || exercise.typeId === 'cardio') {
                    const placeholderIntensity = previous?.intensity || exercise.intensity || '';
                    const placeholderMinutes = previous?.minutes || exercise.minutes || 0;
                    const placeholderSeconds = previous?.seconds || exercise.seconds || 0;

                    return (
                        <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                            <div className="exercise-header">
                                <div>
                                    <div className="exercise-name">
                                        {exercise.name}
                                    </div>
                                    {previous && (
                                        <div style={{ fontSize: '12px', color: '#8a7aaa', marginTop: '4px', fontStyle: 'italic' }}>
                                            Goal: {previous.intensity || 'Any intensity'} - {previous.minutes || 0}:{String(previous.seconds || 0).padStart(2, '0')}
                                        </div>
                                    )}
                                    {!previous && (exercise.intensity !== undefined || exercise.minutes !== undefined) && (
                                        <div style={{ fontSize: '12px', color: '#8a7aaa', marginTop: '4px', fontStyle: 'italic' }}>
                                            Goal: {exercise.intensity || 'Any intensity'} - {exercise.minutes || 0}:{String(exercise.seconds || 0).padStart(2, '0')}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="input-row">
                                <div className="input-group">
                                    <label className="input-label">Intensity</label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value={data.intensity !== undefined ? data.intensity : (exercise.intensity || '')}
                                        onChange={(e) => handleInputChange(exercise.id, 'intensity', e.target.value)}
                                        disabled={isLogged}
                                    />
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Minutes</label>
                                    <input
                                        type="number"
                                        inputMode="numeric"
                                        className={`input-field ${fieldErrors[`${exercise.id}-minutes`] ? 'error' : ''}`}
                                        value={data.minutes !== undefined ? data.minutes : ''}
                                        onChange={(e) => handleInputChange(exercise.id, 'minutes', e.target.value)}
                                        placeholder={placeholderMinutes}
                                        min="0"
                                        disabled={isLogged}
                                        style={{ textAlign: 'center' }}
                                    />
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Seconds</label>
                                    <input
                                        type="number"
                                        inputMode="numeric"
                                        className="input-field"
                                        value={data.seconds !== undefined ? data.seconds : ''}
                                        onChange={(e) => handleInputChange(exercise.id, 'seconds', e.target.value)}
                                        placeholder={placeholderSeconds}
                                        min="0"
                                        max="59"
                                        disabled={isLogged}
                                        style={{ textAlign: 'center' }}
                                    />
                                </div>
                            </div>
                            <button
                                className={`log-btn ${isLogged ? 'logged' : ''}`}
                                onClick={() => logExercise(exercise.id)}
                                disabled={isLogged}
                            >
                                {isLogged ? '‚úì Logged' : 'LOG'}
                            </button>
                        </div>
                    );
                }

                // Standard exercise
                const placeholderWeight = previous?.weight || '';
                const placeholderReps = previous?.reps || '';

                return (
                    <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                        <div className="exercise-header">
                            <div>
                                <div className="exercise-name">
                                    {exercise.name}
                                </div>
                                {(exercise.sets || exercise.minReps || exercise.maxReps) && (
                                    <div style={{ fontSize: '12px', color: '#8a7aaa', marginTop: '4px', fontStyle: 'italic' }}>
                                        Goal: {exercise.sets || 3} sets √ó {exercise.minReps || 8}-{exercise.maxReps || 12} reps
                                    </div>
                                )}
                                {previous && (
                                    <div className="previous-data" style={{ marginTop: '4px' }}>
                                        Last: {previous.weight}lbs √ó {previous.reps} on last set
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="input-row">
                            <div className="input-group">
                                <label className="input-label">Weight (lbs)</label>
                                <input
                                    type="number"
                                    inputMode="decimal"
                                    className={`input-field ${fieldErrors[`${exercise.id}-weight`] ? 'error' : ''}`}
                                    value={data.weight !== undefined ? data.weight : (previous?.weight || '')}
                                    onChange={(e) => handleInputChange(exercise.id, 'weight', e.target.value)}
                                    placeholder={placeholderWeight}
                                    disabled={isLogged}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Reps on Last Set</label>
                                <input
                                    type="number"
                                    inputMode="numeric"
                                    className={`input-field ${fieldErrors[`${exercise.id}-reps`] ? 'error' : ''}`}
                                    value={data.reps || ''}
                                    onChange={(e) => handleInputChange(exercise.id, 'reps', e.target.value)}
                                    placeholder={placeholderReps}
                                    disabled={isLogged}
                                />
                            </div>
                        </div>
                        <button
                            className={`log-btn ${isLogged ? 'logged' : ''}`}
                            onClick={() => logExercise(exercise.id)}
                            disabled={isLogged}
                        >
                            {isLogged ? '‚úì Logged' : 'LOG'}
                        </button>
                    </div>
                );
            };

            // Get total workout days from schedule or exercisesByDay
            const totalWorkoutDays = schedule ? schedule.totalWorkoutDays : Object.keys(exercisesByDay).length;

            // Helper to get day name from exercises (category is the day name)
            const getDayName = (dayNum) => {
                const dayExercises = exercisesByDay[dayNum];
                if (dayExercises && dayExercises.length > 0) {
                    return dayExercises[0].category; // Category is the day name from wizard
                }
                return `Day ${dayNum}`;
            };

            return (
                <>
                    <div className="day-selector">
                        {Array.from({ length: totalWorkoutDays }, (_, i) => i + 1).map(dayNum => {
                            const dayName = getDayName(dayNum);
                            return (
                                <button
                                    key={dayNum}
                                    className={`day-btn ${currentDay === dayNum ? 'active' : ''}`}
                                    onClick={() => setCurrentDay(dayNum)}
                                >
                                    {dayName}{todayDay === dayNum ? ' (Today)' : ''}
                                </button>
                            );
                        })}
                    </div>

                    {categories.map(category => (
                        <React.Fragment key={category}>
                            <div className="section-title">{category}</div>
                            {exercisesByCategory[category].map(renderExercise)}
                        </React.Fragment>
                    ))}

                    <button className="save-btn" onClick={completeDay}>
                        Submit Day and View Breakdown
                    </button>
                </>
            );
        }


        function WeeklyView({ workoutHistory, viewingWeek, setViewingWeek, currentWeek, exercisesByDay, onEditWorkout }) {
            const weekWorkouts = workoutHistory.filter(w => w.week === viewingWeek);

            return (
                <>
                    <div className="week-nav">
                        <button
                            className="week-nav-btn"
                            onClick={() => setViewingWeek(viewingWeek - 1)}
                            disabled={viewingWeek <= 1}
                        >
                            ‚Üê Prev
                        </button>
                        <div className="week-title">
                            Week {viewingWeek}
                            {viewingWeek === currentWeek && ' (Current)'}
                        </div>
                        <button
                            className="week-nav-btn"
                            onClick={() => setViewingWeek(viewingWeek + 1)}
                            disabled={viewingWeek >= currentWeek}
                        >
                            Next ‚Üí
                        </button>
                    </div>

                    {weekWorkouts.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon">üìä</div>
                            <div>No workouts in Week {viewingWeek}</div>
                        </div>
                    ) : (
                        <>
                            {weekWorkouts.map((workout, idx) => {
                                const date = new Date(workout.date);
                                const formattedDate = date.toLocaleDateString('en-US', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                });
                                const formattedTime = date.toLocaleTimeString('en-US', {
                                    hour: 'numeric',
                                    minute: '2-digit'
                                });

                                // Get all exercises for this day
                                const allExercises = exercisesByDay[workout.day] || [];
                                const completedIds = new Set(workout.exercises.map(e => e.id));

                                // Calculate sequential day number (total workouts completed)
                                const workoutIndex = workoutHistory.indexOf(workout);
                                const dayNumber = workoutHistory.length - workoutIndex;

                                return (
                                    <div key={idx} className="history-item">
                                        <div className="history-date" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <span>Day {dayNumber} - {formattedDate}</span>
                                            <button
                                                onClick={() => onEditWorkout(workout)}
                                                style={{
                                                    background: 'none',
                                                    border: 'none',
                                                    color: '#6a5a8a',
                                                    cursor: 'pointer',
                                                    fontSize: '18px',
                                                    padding: '4px 8px'
                                                }}
                                            >
                                                ‚úèÔ∏è
                                            </button>
                                        </div>
                                        {allExercises.map((expectedExercise) => {
                                            const completedExercise = workout.exercises.find(e => e.id === expectedExercise.id);
                                            return (
                                                <div key={expectedExercise.id} className="history-exercise">
                                                    <div className="history-exercise-name">{expectedExercise.name}</div>
                                                    <div className="history-exercise-data">
                                                        {completedExercise ? (
                                                            completedExercise.type === 'assault-bike'
                                                                ? (completedExercise.rounds ? `${completedExercise.rounds} rounds` : <span style={{ color: '#555' }}>NA</span>)
                                                                : completedExercise.type === 'stairmaster'
                                                                ? (completedExercise.time ? `${completedExercise.level || 'Level 7'} - ${completedExercise.time}` : <span style={{ color: '#555' }}>NA</span>)
                                                                : (completedExercise.isCardio || completedExercise.type === 'cardio')
                                                                ? ((completedExercise.intensity || completedExercise.minutes !== undefined)
                                                                    ? `${completedExercise.intensity || 'No intensity'} - ${completedExercise.minutes || 0}:${String(completedExercise.seconds || 0).padStart(2, '0')}`
                                                                    : <span style={{ color: '#555' }}>NA</span>)
                                                                : (completedExercise.weight && completedExercise.reps
                                                                    ? `${completedExercise.weight}${completedExercise.weight === 'Body Weight' ? '' : 'lbs'} √ó ${completedExercise.reps}`
                                                                    : <span style={{ color: '#555' }}>NA</span>)
                                                        ) : (
                                                            <span style={{ color: '#555' }}>NA</span>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                );
                            })}
                        </>
                    )}
                </>
            );
        }

        function ProgressView({ workoutHistory, selectedExercise, setSelectedExercise, exercisesByDay }) {
            const allExercises = Object.values(exercisesByDay).flat();

            useEffect(() => {
                if (workoutHistory.length === 0) return;

                const ctx = document.getElementById('progressChart');
                if (!ctx) return;

                const exercise = allExercises.find(e => e.id === selectedExercise);
                const exerciseData = workoutHistory
                    .map(w => ({
                        date: new Date(w.date),
                        exercise: w.exercises.find(e => e.id === selectedExercise)
                    }))
                    .filter(d => d.exercise)
                    .reverse();

                if (exercise?.type === 'assault-bike') {
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: exerciseData.map(d => d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                            datasets: [
                                {
                                    label: 'Rounds',
                                    data: exerciseData.map(d => parseInt(d.exercise.rounds) || 0),
                                    borderColor: '#0a84ff',
                                    backgroundColor: 'rgba(10, 132, 255, 0.1)',
                                    tension: 0.3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { labels: { color: '#fff' } }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#888' },
                                    grid: { color: '#2a2a2a' },
                                    title: {
                                        display: true,
                                        text: 'Date',
                                        color: '#888'
                                    }
                                },
                                y: {
                                    ticks: { color: '#888' },
                                    grid: { color: '#2a2a2a' },
                                    title: {
                                        display: true,
                                        text: 'Rounds',
                                        color: '#888'
                                    }
                                }
                            }
                        }
                    });
                    return () => chart.destroy();
                }

                if (exercise?.type === 'stairmaster') {
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: exerciseData.map(d => d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                            datasets: [
                                {
                                    label: 'Time (seconds)',
                                    data: exerciseData.map(d => parseTimeToSeconds(d.exercise.time)),
                                    borderColor: '#0a84ff',
                                    backgroundColor: 'rgba(10, 132, 255, 0.1)',
                                    tension: 0.3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { labels: { color: '#fff' } }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#888' },
                                    grid: { color: '#2a2a2a' },
                                    title: {
                                        display: true,
                                        text: 'Date',
                                        color: '#888'
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: '#888',
                                        callback: function(value) {
                                            return formatSecondsToTime(value);
                                        }
                                    },
                                    grid: { color: '#2a2a2a' },
                                    title: {
                                        display: true,
                                        text: 'Time',
                                        color: '#888'
                                    }
                                }
                            }
                        }
                    });
                    return () => chart.destroy();
                }

                if (exercise?.isCardio || exercise?.typeId === 'cardio') {
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: exerciseData.map(d => d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                            datasets: [
                                {
                                    label: 'Time (seconds)',
                                    data: exerciseData.map(d => {
                                        const minutes = parseInt(d.exercise.minutes) || 0;
                                        const seconds = parseInt(d.exercise.seconds) || 0;
                                        return minutes * 60 + seconds;
                                    }),
                                    borderColor: '#0a84ff',
                                    backgroundColor: 'rgba(10, 132, 255, 0.1)',
                                    tension: 0.3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { labels: { color: '#fff' } }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#888' },
                                    grid: { color: '#2a2a2a' },
                                    title: {
                                        display: true,
                                        text: 'Date',
                                        color: '#888'
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: '#888',
                                        callback: function(value) {
                                            return formatSecondsToTime(value);
                                        }
                                    },
                                    grid: { color: '#2a2a2a' },
                                    title: {
                                        display: true,
                                        text: 'Time',
                                        color: '#888'
                                    }
                                }
                            }
                        }
                    });
                    return () => chart.destroy();
                }

                // Standard exercise - show only weight
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: exerciseData.map(d => d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        datasets: [
                            {
                                label: 'Weight (lbs)',
                                data: exerciseData.map(d => {
                                    if (d.exercise.weight === 'Body Weight') return 0;
                                    return parseFloat(d.exercise.weight) || 0;
                                }),
                                borderColor: '#0a84ff',
                                backgroundColor: 'rgba(10, 132, 255, 0.1)',
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#888' },
                                grid: { color: '#2a2a2a' },
                                title: {
                                    display: true,
                                    text: 'Date',
                                    color: '#888'
                                }
                            },
                            y: {
                                ticks: { color: '#888' },
                                grid: { color: '#2a2a2a' },
                                title: {
                                    display: true,
                                    text: 'Weight (lbs)',
                                    color: '#888'
                                }
                            }
                        }
                    }
                });

                return () => chart.destroy();
            }, [workoutHistory, selectedExercise]);

            if (workoutHistory.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">üìà</div>
                        <div>Complete some workouts to see progress</div>
                    </div>
                );
            }

            return (
                <>
                    <select
                        className="exercise-select"
                        value={selectedExercise}
                        onChange={(e) => setSelectedExercise(e.target.value)}
                    >
                        {Object.keys(exercisesByDay).sort((a, b) => parseInt(a) - parseInt(b)).map(dayNum => {
                            const dayExercises = exercisesByDay[dayNum];
                            // Group exercises by category
                            const categories = [...new Set(dayExercises.map(e => e.category))];

                            return categories.map(category => (
                                <optgroup key={`${dayNum}-${category}`} label={`Day ${dayNum} - ${category}`}>
                                    {dayExercises.filter(e => e.category === category).map(ex => (
                                        <option key={ex.id} value={ex.id}>{ex.name}</option>
                                    ))}
                                </optgroup>
                            ));
                        })}
                    </select>
                    <div className="chart-container">
                        <div className="chart-title">
                            {allExercises.find(e => e.id === selectedExercise)?.name}
                        </div>
                        <canvas id="progressChart"></canvas>
                    </div>
                </>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
